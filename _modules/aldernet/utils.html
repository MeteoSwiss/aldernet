
<!DOCTYPE html>

<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>aldernet.utils &#8212; Aldernet 0.1.0 documentation</title>
    <link rel="stylesheet" type="text/css" href="../../_static/pygments.css" />
    <link rel="stylesheet" type="text/css" href="../../_static/alabaster.css" />
    <script data-url_root="../../" id="documentation_options" src="../../_static/documentation_options.js"></script>
    <script src="../../_static/jquery.js"></script>
    <script src="../../_static/underscore.js"></script>
    <script src="../../_static/_sphinx_javascript_frameworks_compat.js"></script>
    <script src="../../_static/doctools.js"></script>
    <script src="../../_static/sphinx_highlight.js"></script>
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" />
   
  <link rel="stylesheet" href="../../_static/custom.css" type="text/css" />
  
  
  <meta name="viewport" content="width=device-width, initial-scale=0.9, maximum-scale=0.9" />

  </head><body>
  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          

          <div class="body" role="main">
            
  <h1>Source code for aldernet.utils</h1><div class="highlight"><pre>
<span></span><span class="sd">&quot;&quot;&quot;Provide all required functions for the training script.</span>

<span class="sd">Functions:</span>
<span class="sd">~~~~~~~~~~</span>
<span class="sd">- build_unet(conv: bool=True) -&gt; tf.keras.Model: builds a UNet model for predicting</span>
<span class="sd">    pollenconcentrations.</span>

<span class="sd">- cbr(filters, name=None) -&gt; Sequential: Creates a convolutional block with batch</span>
<span class="sd">    normalization and leaky ReLU activation.</span>

<span class="sd">- compile_generator(height, width, weather_features, noise_dim, filters): Compiles a</span>
<span class="sd">    generator model using Tensorflow with the specified parameters.</span>

<span class="sd">- create_batcher(data: xarray.Dataset, batch_size: int, add_weather: bool, shuffle:</span>
<span class="sd">    bool) -&gt; Batcher: creates a batcher object for the given data and parameters.</span>

<span class="sd">- create_optimizer(learning_rate: float, beta_1: float, beta_2: float)</span>
<span class="sd">    -&gt;tf.keras.optimizers.Adam: creates an optimizer object for the model.</span>

<span class="sd">- define_filters(zoom: str) -&gt; List[int]: Define the filters based on the provided zoom.</span>

<span class="sd">- down(filters, name=None) -&gt; Sequential: Creates a downsampling block with</span>
<span class="sd">    convolutional layer, batch normalization, and leaky ReLU activation.</span>

<span class="sd">- generate_report(df: pd.DataFrame, settings: Dict[str, Union[str, int, float, bool]])</span>
<span class="sd">    -&gt; None: Generate a report based on the provided dataframe and settings.</span>

<span class="sd">- get_callbacks(run_path: str, sha: str) -&gt; List[ray.tune.callback.TrialCallback]: Get</span>
<span class="sd">    the callbacks based on the provided run path and sha.</span>

<span class="sd">- get_scheduler(settings: Dict[str, Union[str, int, float, bool]]) -&gt;</span>
<span class="sd">    ray.tune.schedulers.asha.ASHAScheduler: Get the ASHAScheduler based on the provided</span>
<span class="sd">    settings.</span>

<span class="sd">- get_tune_config(run_path: str) -&gt; Dict[str, Union[str, Dict[str, str], float]]: Get</span>
<span class="sd">    the Tune configuration based on the provided run path.</span>

<span class="sd">- load_data(hostname: str, settings: Dict[str, Union[str, int, float, bool]]) -&gt;</span>
<span class="sd">    Tuple[xr.Dataset, xr.Dataset]: Load data based on the provided hostname and</span>
<span class="sd">    settings.</span>

<span class="sd">- load_pretrained_model() -&gt; keras.engine.sequential.Sequential: Load a pre-trained</span>
<span class="sd">    model.</span>

<span class="sd">- predict_season(best_model: tf.keras.Model, data_valid: xr.Dataset, noise_dim: int,</span>
<span class="sd">    add_weather: bool) -&gt; np.ndarray: predicts the pollen season with the best model and</span>
<span class="sd">    returns a numpy array of predicted values.</span>

<span class="sd">- prepare_generator(run_path: str, settings: Dict[str, Union[str, int, float, bool]],</span>
<span class="sd">    data_train: xr.Dataset) -&gt; keras.engine.training.Model: Prepare the generator based</span>
<span class="sd">    on the provided settings and data.</span>

<span class="sd">- read_scaling_data() -&gt; Tuple[float, float]: reads scaling data from a file and returns</span>
<span class="sd">    a tuple containing the center and scale.</span>

<span class="sd">- rsync_mlruns(run_path: str) -&gt; None: Rsync the mlruns based on the provided run path.</span>

<span class="sd">- save_generator_summary_and_plot(run_path: str, generator: keras.engine.training.Model)</span>
<span class="sd">    -&gt; None: Save the generator summary and plot based on the provided run path and</span>
<span class="sd">    generator.</span>

<span class="sd">- save_predictions_and_generate_report(settings: Dict[str, Union[str, int, float,</span>
<span class="sd">    bool]], best_model: keras.engine.sequential.Sequential, data_valid: xr.Dataset) -&gt;</span>
<span class="sd">    None: Save the predictions and generate the report based on the provided settings,</span>
<span class="sd">    best_model, and data_valid.</span>

<span class="sd">- setup_directories(run_path: str, tune_trial: str) -&gt; None: creates directories for</span>
<span class="sd">    visualizations.</span>

<span class="sd">- setup_output_directory(settings: Dict[str, Union[str, int, float, bool]]) -&gt; str: Set</span>
<span class="sd">    up the output directory based on the provided settings.</span>


<span class="sd">- train_and_evaluate_model(run_path: str, settings: Dict[str, Union[str, int, float,</span>
<span class="sd">    bool]], data_train: xr.Dataset, data_valid: xr.Dataset, sha: str) -&gt;</span>
<span class="sd">    keras.engine.sequential.Sequential: Train and evaluate the model based on the</span>
<span class="sd">    provided settings, data, and run path.</span>

<span class="sd">- train_epoch(generator: tf.keras.Model, optimizer_gen: tf.keras.optimizers.Optimizer,</span>
<span class="sd">    data_train:Batcher, noise_dim: int, add_weather: bool, center: float, scale: float,</span>
<span class="sd">    epoch: tf.Variable,step: tf.Variable, run_path: str, tune_trial: str) -&gt; np.ndarray:</span>
<span class="sd">    trains the model for one epoch and returns a numpy array of loss values.</span>

<span class="sd">- train_model_simple(data_train: xr.Dataset, data_valid: xr.Dataset, epochs: int,</span>
<span class="sd">    add_weather: bool, conv: bool=True) -&gt; tf.keras.Model: trains a simple model for</span>
<span class="sd">    predicting pollen concentrations and returns the trained model.</span>

<span class="sd">- train_model(config: Dict[str, float], generator: tf.keras.Model, data_train:</span>
<span class="sd">    Batcher,data_valid: Batcher, run_path: str, noise_dim: int, add_weather: bool,</span>
<span class="sd">    shuffle: bool) -&gt; None: trains the model using a configuration dictionary and saves</span>
<span class="sd">    the best model.</span>

<span class="sd">- train_step(generator, optimizer_gen, input_train, target_train, weather_train,</span>
<span class="sd">    noise_dim, add_weather): Performs one training step for the generator of a NNet to</span>
<span class="sd">    generate images of pollen concentrations in the air given an input image of trees</span>
<span class="sd">    and weather data.</span>

<span class="sd">- train_with_ray_tune(run_path: str, settings: Dict[str, Union[str, int, float, bool]],</span>
<span class="sd">    data_train: xr.Dataset, data_valid: xr.Dataset, sha: str) -&gt;</span>
<span class="sd">    keras.engine.sequential.Sequential: Train the model using Ray Tune based on the</span>
<span class="sd">    provided settings, data, and run path.</span>

<span class="sd">- train_without_ray_tune(settings: Dict[str, Union[str, int, float, bool]], data_train:</span>
<span class="sd">    xr.Dataset, data_valid: xr.Dataset) -&gt; keras.engine.sequential.Sequential: Train the</span>
<span class="sd">    model without Ray Tune based on the provided settings and data.</span>

<span class="sd">- up(filters, name=None) -&gt; Sequential: Creates an upsampling blockwith transposed</span>
<span class="sd">    convolutional layer, batch normalization, and leaky ReLU activation.</span>

<span class="sd">- validate_epoch(generator: tf.keras.Model, data_valid: Batcher, noise_dim: int,</span>
<span class="sd">    add_weather: bool, center: float, scale: float, epoch: tf.Variable, step_valid: int,</span>
<span class="sd">    run_path: str, tune_trial: str) -&gt; Tuple[np.ndarray, int]: validates the model for</span>
<span class="sd">    one epoch and returns a tuple containing a numpy array of loss values and the step</span>
<span class="sd">    number.</span>


<span class="sd">Attributes:</span>
<span class="sd">~~~~~~~~~~~</span>

<span class="sd">All functions and classes defined in this script.</span>

<span class="sd">COPYRIGHT (c) 2022 MeteoSwiss, contributors listed in AUTHORS. Distributed under the</span>
<span class="sd">terms of the BSD 3-Clause License. SPDX-License-Identifier: BSD-3-Clause</span>

<span class="sd">This docstring was autogenerated by GPT-4.</span>

<span class="sd">&quot;&quot;&quot;</span>

<span class="c1"># pylint: disable=C0302</span>
<span class="c1"># pyright: reportOptionalMemberAccess=false,reportOptionalMemberAccess=false pyright:</span>
<span class="c1"># reportGeneralTypeIssues=false</span>

<span class="c1"># Standard library</span>
<span class="kn">import</span> <span class="nn">datetime</span>
<span class="kn">import</span> <span class="nn">math</span>
<span class="kn">import</span> <span class="nn">subprocess</span>
<span class="kn">import</span> <span class="nn">time</span>
<span class="kn">from</span> <span class="nn">contextlib</span> <span class="kn">import</span> <span class="n">redirect_stdout</span>
<span class="kn">from</span> <span class="nn">pathlib</span> <span class="kn">import</span> <span class="n">Path</span>

<span class="c1"># Third-party</span>
<span class="kn">import</span> <span class="nn">keras</span>  <span class="c1"># type: ignore</span>
<span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>  <span class="c1"># type: ignore</span>
<span class="kn">import</span> <span class="nn">mlflow</span>  <span class="c1"># type: ignore</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>  <span class="c1"># type: ignore</span>
<span class="kn">import</span> <span class="nn">tensorflow</span> <span class="k">as</span> <span class="nn">tf</span>  <span class="c1"># type: ignore</span>
<span class="kn">import</span> <span class="nn">xarray</span> <span class="k">as</span> <span class="nn">xr</span>
<span class="kn">from</span> <span class="nn">keras</span> <span class="kn">import</span> <span class="n">layers</span>
<span class="kn">from</span> <span class="nn">keras.engine.sequential</span> <span class="kn">import</span> <span class="n">Sequential</span>  <span class="c1"># type: ignore</span>
<span class="kn">from</span> <span class="nn">keras.utils.vis_utils</span> <span class="kn">import</span> <span class="n">plot_model</span>  <span class="c1"># type: ignore</span>
<span class="kn">from</span> <span class="nn">pyprojroot</span> <span class="kn">import</span> <span class="n">here</span>  <span class="c1"># type: ignore</span>
<span class="kn">from</span> <span class="nn">ray</span> <span class="kn">import</span> <span class="n">init</span>
<span class="kn">from</span> <span class="nn">ray</span> <span class="kn">import</span> <span class="n">shutdown</span>
<span class="kn">from</span> <span class="nn">ray</span> <span class="kn">import</span> <span class="n">tune</span>
<span class="kn">from</span> <span class="nn">ray.air</span> <span class="kn">import</span> <span class="n">Checkpoint</span>
<span class="kn">from</span> <span class="nn">ray.air</span> <span class="kn">import</span> <span class="n">session</span>
<span class="kn">from</span> <span class="nn">ray.air.integrations.mlflow</span> <span class="kn">import</span> <span class="n">MLflowLoggerCallback</span>  <span class="c1"># type: ignore</span>
<span class="kn">from</span> <span class="nn">ray.tune.schedulers</span> <span class="kn">import</span> <span class="n">ASHAScheduler</span>

<span class="c1"># First-party</span>
<span class="kn">from</span> <span class="nn">aldernet.data.data_utils</span> <span class="kn">import</span> <span class="n">Batcher</span>
<span class="kn">from</span> <span class="nn">aldernet.data.data_utils</span> <span class="kn">import</span> <span class="n">Stations</span>


<div class="viewcode-block" id="load_data"><a class="viewcode-back" href="../../modules.html#aldernet.utils.load_data">[docs]</a><span class="k">def</span> <span class="nf">load_data</span><span class="p">(</span><span class="n">hostname</span><span class="p">,</span> <span class="n">settings</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Load training and validation data for the specified hostname and zoom level.</span>

<span class="sd">    Args:</span>
<span class="sd">        hostname (str): Name of the host to load data from. settings (dict): Dictionary</span>
<span class="sd">        of settings, including zoom level.</span>

<span class="sd">    Returns:</span>
<span class="sd">        tuple: A tuple of two xarray datasets containing the training and validation</span>
<span class="sd">        data.</span>

<span class="sd">    Raises:</span>
<span class="sd">        ValueError: If the hostname is not recognized.</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="s2">&quot;tsa&quot;</span> <span class="ow">in</span> <span class="n">hostname</span><span class="p">:</span>
        <span class="n">data_train</span> <span class="o">=</span> <span class="n">xr</span><span class="o">.</span><span class="n">open_zarr</span><span class="p">(</span>
            <span class="s2">&quot;/scratch/sadamov/pyprojects_data/aldernet/5_threshold&quot;</span>
            <span class="o">+</span> <span class="n">settings</span><span class="p">[</span><span class="s2">&quot;zoom&quot;</span><span class="p">]</span>
            <span class="o">+</span> <span class="s2">&quot;/data_train.zarr&quot;</span>
        <span class="p">)</span>
        <span class="n">data_valid</span> <span class="o">=</span> <span class="n">xr</span><span class="o">.</span><span class="n">open_zarr</span><span class="p">(</span>
            <span class="s2">&quot;/scratch/sadamov/pyprojects_data/aldernet/5_threshold&quot;</span>
            <span class="o">+</span> <span class="n">settings</span><span class="p">[</span><span class="s2">&quot;zoom&quot;</span><span class="p">]</span>
            <span class="o">+</span> <span class="s2">&quot;/data_valid.zarr&quot;</span>
        <span class="p">)</span>
    <span class="k">elif</span> <span class="s2">&quot;nid&quot;</span> <span class="ow">in</span> <span class="n">hostname</span><span class="p">:</span>
        <span class="n">data_train</span> <span class="o">=</span> <span class="n">xr</span><span class="o">.</span><span class="n">open_zarr</span><span class="p">(</span>
            <span class="s2">&quot;/scratch/e1000/meteoswiss/scratch/sadamov/pyprojects_data/aldernet/&quot;</span>
            <span class="o">+</span> <span class="n">settings</span><span class="p">[</span><span class="s2">&quot;zoom&quot;</span><span class="p">]</span>
            <span class="o">+</span> <span class="s2">&quot;/data_final/data_train.zarr&quot;</span>
        <span class="p">)</span>
        <span class="n">data_valid</span> <span class="o">=</span> <span class="n">xr</span><span class="o">.</span><span class="n">open_zarr</span><span class="p">(</span>
            <span class="s2">&quot;/scratch/e1000/meteoswiss/scratch/sadamov/pyprojects_data/aldernet/&quot;</span>
            <span class="o">+</span> <span class="n">settings</span><span class="p">[</span><span class="s2">&quot;zoom&quot;</span><span class="p">]</span>
            <span class="o">+</span> <span class="s2">&quot;/data_final/data_valid.zarr&quot;</span>
        <span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Unknown hostname. Data cannot be loaded.&quot;</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">data_train</span><span class="p">,</span> <span class="n">data_valid</span></div>


<div class="viewcode-block" id="setup_output_directory"><a class="viewcode-back" href="../../modules.html#aldernet.utils.setup_output_directory">[docs]</a><span class="k">def</span> <span class="nf">setup_output_directory</span><span class="p">(</span><span class="n">settings</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Create a new output directory and return the path to the new directory.</span>

<span class="sd">    Args:</span>
<span class="sd">        settings (dict): Dictionary of settings.</span>

<span class="sd">    Returns:</span>
<span class="sd">        str: The path to the new output directory.</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">run_path</span> <span class="o">=</span> <span class="p">(</span>
        <span class="nb">str</span><span class="p">(</span><span class="n">here</span><span class="p">())</span> <span class="o">+</span> <span class="s2">&quot;/output/&quot;</span> <span class="o">+</span> <span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s2">&quot;%Y%m</span><span class="si">%d</span><span class="s2">_%H%M%S&quot;</span><span class="p">)</span>
    <span class="p">)</span>
    <span class="k">if</span> <span class="n">settings</span><span class="p">[</span><span class="s2">&quot;tune_with_ray&quot;</span><span class="p">]</span> <span class="ow">and</span> <span class="n">settings</span><span class="p">[</span><span class="s2">&quot;retrain_model&quot;</span><span class="p">]:</span>
        <span class="n">Path</span><span class="p">(</span><span class="n">run_path</span> <span class="o">+</span> <span class="s2">&quot;/viz/valid&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">mkdir</span><span class="p">(</span><span class="n">parents</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">exist_ok</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">run_path</span></div>


<div class="viewcode-block" id="train_and_evaluate_model"><a class="viewcode-back" href="../../modules.html#aldernet.utils.train_and_evaluate_model">[docs]</a><span class="k">def</span> <span class="nf">train_and_evaluate_model</span><span class="p">(</span><span class="n">run_path</span><span class="p">,</span> <span class="n">settings</span><span class="p">,</span> <span class="n">data_train</span><span class="p">,</span> <span class="n">data_valid</span><span class="p">,</span> <span class="n">sha</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Train and evaluate a neural network model using the specified data and settings.</span>

<span class="sd">    Args:</span>
<span class="sd">        run_path (str): Path to the output directory for storing results. settings</span>
<span class="sd">        (dict): Dictionary of settings. data_train (xarray.Dataset): Training data.</span>
<span class="sd">        data_valid (xarray.Dataset): Validation data. sha (str): A string containing the</span>
<span class="sd">        Git commit hash for the current code.</span>

<span class="sd">    Returns:</span>
<span class="sd">        tensorflow.python.keras.engine.functional.Functional: The trained neural network</span>
<span class="sd">        model.</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">settings</span><span class="p">[</span><span class="s2">&quot;retrain_model&quot;</span><span class="p">]:</span>
        <span class="k">if</span> <span class="n">settings</span><span class="p">[</span><span class="s2">&quot;tune_with_ray&quot;</span><span class="p">]:</span>
            <span class="n">best_model</span> <span class="o">=</span> <span class="n">train_with_ray_tune</span><span class="p">(</span>
                <span class="n">run_path</span><span class="p">,</span> <span class="n">settings</span><span class="p">,</span> <span class="n">data_train</span><span class="p">,</span> <span class="n">data_valid</span><span class="p">,</span> <span class="n">sha</span>
            <span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">best_model</span> <span class="o">=</span> <span class="n">train_without_ray_tune</span><span class="p">(</span><span class="n">settings</span><span class="p">,</span> <span class="n">data_train</span><span class="p">,</span> <span class="n">data_valid</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">best_model</span> <span class="o">=</span> <span class="n">load_pretrained_model</span><span class="p">()</span>
    <span class="k">return</span> <span class="n">best_model</span></div>


<div class="viewcode-block" id="train_with_ray_tune"><a class="viewcode-back" href="../../modules.html#aldernet.utils.train_with_ray_tune">[docs]</a><span class="k">def</span> <span class="nf">train_with_ray_tune</span><span class="p">(</span><span class="n">run_path</span><span class="p">,</span> <span class="n">settings</span><span class="p">,</span> <span class="n">data_train</span><span class="p">,</span> <span class="n">data_valid</span><span class="p">,</span> <span class="n">sha</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Train a neural network model using Ray Tune for hyperparameter tuning.</span>

<span class="sd">    Args:</span>
<span class="sd">        run_path (str): Path to the output directory for storing results. settings</span>
<span class="sd">        (dict): Dictionary of settings. data_train (xarray.Dataset): Training data.</span>
<span class="sd">        data_valid (xarray.Dataset): Validation data. sha (str): A string containing the</span>
<span class="sd">        Git commit hash for the current code.</span>

<span class="sd">    Returns:</span>
<span class="sd">        tensorflow.python.keras.engine.functional.Functional: The trained neural network</span>
<span class="sd">        model.</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">generator</span> <span class="o">=</span> <span class="n">prepare_generator</span><span class="p">(</span><span class="n">run_path</span><span class="p">,</span> <span class="n">settings</span><span class="p">,</span> <span class="n">data_train</span><span class="p">)</span>

    <span class="n">shutdown</span><span class="p">()</span>
    <span class="n">init</span><span class="p">(</span><span class="n">runtime_env</span><span class="o">=</span><span class="n">get_runtime_env</span><span class="p">())</span>

    <span class="n">tuner</span> <span class="o">=</span> <span class="n">tune</span><span class="o">.</span><span class="n">run</span><span class="p">(</span>
        <span class="n">tune</span><span class="o">.</span><span class="n">with_parameters</span><span class="p">(</span>
            <span class="n">train_model</span><span class="p">,</span>
            <span class="n">generator</span><span class="o">=</span><span class="n">generator</span><span class="p">,</span>
            <span class="n">data_train</span><span class="o">=</span><span class="n">data_train</span><span class="p">,</span>
            <span class="n">data_valid</span><span class="o">=</span><span class="n">data_valid</span><span class="p">,</span>
            <span class="n">run_path</span><span class="o">=</span><span class="n">run_path</span><span class="p">,</span>
            <span class="n">noise_dim</span><span class="o">=</span><span class="n">settings</span><span class="p">[</span><span class="s2">&quot;noise_dim&quot;</span><span class="p">],</span>
            <span class="n">add_weather</span><span class="o">=</span><span class="n">settings</span><span class="p">[</span><span class="s2">&quot;add_weather&quot;</span><span class="p">],</span>
            <span class="n">shuffle</span><span class="o">=</span><span class="n">settings</span><span class="p">[</span><span class="s2">&quot;shuffle&quot;</span><span class="p">],</span>
        <span class="p">),</span>
        <span class="n">metric</span><span class="o">=</span><span class="s2">&quot;Loss&quot;</span><span class="p">,</span>
        <span class="n">mode</span><span class="o">=</span><span class="s2">&quot;min&quot;</span><span class="p">,</span>
        <span class="n">num_samples</span><span class="o">=</span><span class="n">settings</span><span class="p">[</span><span class="s2">&quot;members&quot;</span><span class="p">],</span>
        <span class="n">scheduler</span><span class="o">=</span><span class="n">get_scheduler</span><span class="p">(</span><span class="n">settings</span><span class="p">),</span>
        <span class="n">resources_per_trial</span><span class="o">=</span><span class="n">settings</span><span class="p">[</span><span class="s2">&quot;device&quot;</span><span class="p">],</span>
        <span class="n">config</span><span class="o">=</span><span class="n">get_tune_config</span><span class="p">(),</span>
        <span class="n">local_dir</span><span class="o">=</span><span class="n">run_path</span><span class="p">,</span>
        <span class="n">keep_checkpoints_num</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
        <span class="n">callbacks</span><span class="o">=</span><span class="n">get_callbacks</span><span class="p">(</span><span class="n">run_path</span><span class="p">,</span> <span class="n">sha</span><span class="p">),</span>
    <span class="p">)</span>
    <span class="n">rsync_mlruns</span><span class="p">(</span><span class="n">run_path</span><span class="p">)</span>
    <span class="n">best_model</span> <span class="o">=</span> <span class="n">tuner</span><span class="o">.</span><span class="n">best_checkpoint</span><span class="o">.</span><span class="n">to_dict</span><span class="p">()[</span><span class="s2">&quot;model&quot;</span><span class="p">]</span>
    <span class="k">return</span> <span class="n">best_model</span></div>


<div class="viewcode-block" id="prepare_generator"><a class="viewcode-back" href="../../modules.html#aldernet.utils.prepare_generator">[docs]</a><span class="k">def</span> <span class="nf">prepare_generator</span><span class="p">(</span><span class="n">run_path</span><span class="p">,</span> <span class="n">settings</span><span class="p">,</span> <span class="n">data_train</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Prepare the generator model for training the NNet.</span>

<span class="sd">    Args:</span>
<span class="sd">        run_path (str): Path to the output directory for storing results. settings</span>
<span class="sd">        (dict): Dictionary of settings. data_train (xarray.Dataset): Training data.</span>

<span class="sd">    Returns:</span>
<span class="sd">        tensorflow.python.keras.engine.functional.Functional: The compiled generator</span>
<span class="sd">        model.</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">height</span> <span class="o">=</span> <span class="n">data_train</span><span class="p">[</span><span class="n">settings</span><span class="p">[</span><span class="s2">&quot;input_species&quot;</span><span class="p">]]</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
    <span class="n">width</span> <span class="o">=</span> <span class="n">data_train</span><span class="p">[</span><span class="n">settings</span><span class="p">[</span><span class="s2">&quot;input_species&quot;</span><span class="p">]]</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>
    <span class="k">if</span> <span class="n">settings</span><span class="p">[</span><span class="s2">&quot;add_weather&quot;</span><span class="p">]:</span>
        <span class="n">weather_features</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span>
            <span class="n">data_train</span><span class="o">.</span><span class="n">drop_vars</span><span class="p">(</span>
                <span class="p">(</span><span class="n">settings</span><span class="p">[</span><span class="s2">&quot;target_species&quot;</span><span class="p">],</span> <span class="n">settings</span><span class="p">[</span><span class="s2">&quot;input_species&quot;</span><span class="p">])</span>
            <span class="p">)</span><span class="o">.</span><span class="n">data_vars</span>
        <span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">weather_features</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">filters</span> <span class="o">=</span> <span class="n">define_filters</span><span class="p">(</span><span class="n">settings</span><span class="p">[</span><span class="s2">&quot;zoom&quot;</span><span class="p">])</span>
        <span class="n">generator</span> <span class="o">=</span> <span class="n">compile_generator</span><span class="p">(</span>
            <span class="n">height</span><span class="p">,</span> <span class="n">width</span><span class="p">,</span> <span class="n">weather_features</span><span class="p">,</span> <span class="n">settings</span><span class="p">[</span><span class="s2">&quot;noise_dim&quot;</span><span class="p">],</span> <span class="n">filters</span>
        <span class="p">)</span>
    <span class="n">save_generator_summary_and_plot</span><span class="p">(</span><span class="n">run_path</span><span class="p">,</span> <span class="n">generator</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">generator</span></div>


<div class="viewcode-block" id="save_generator_summary_and_plot"><a class="viewcode-back" href="../../modules.html#aldernet.utils.save_generator_summary_and_plot">[docs]</a><span class="k">def</span> <span class="nf">save_generator_summary_and_plot</span><span class="p">(</span><span class="n">run_path</span><span class="p">,</span> <span class="n">generator</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Save a summary of the generator model and a visualization of its architecture.</span>

<span class="sd">    Args:</span>
<span class="sd">        run_path (str): Path to the output directory for storing results.</span>
<span class="sd">        generator(tensorflow.python.keras.engine.functional.Functional): The generator</span>
<span class="sd">        model to summarize and plot.</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">run_path</span> <span class="o">+</span> <span class="s2">&quot;/generator_summary.txt&quot;</span><span class="p">,</span> <span class="s2">&quot;w&quot;</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="s2">&quot;UTF-8&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">handle</span><span class="p">:</span>
        <span class="k">with</span> <span class="n">redirect_stdout</span><span class="p">(</span><span class="n">handle</span><span class="p">):</span>
            <span class="n">generator</span><span class="o">.</span><span class="n">summary</span><span class="p">()</span>
            <span class="n">plot_model</span><span class="p">(</span>
                <span class="n">generator</span><span class="p">,</span> <span class="n">to_file</span><span class="o">=</span><span class="n">run_path</span> <span class="o">+</span> <span class="s2">&quot;/generator.png&quot;</span><span class="p">,</span> <span class="n">show_shapes</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">dpi</span><span class="o">=</span><span class="mi">96</span>
            <span class="p">)</span></div>


<div class="viewcode-block" id="get_runtime_env"><a class="viewcode-back" href="../../modules.html#aldernet.utils.get_runtime_env">[docs]</a><span class="k">def</span> <span class="nf">get_runtime_env</span><span class="p">():</span>
    <span class="sd">&quot;&quot;&quot;Get the runtime environment for Ray Tune.</span>

<span class="sd">    Returns:</span>
<span class="sd">        dict: A dictionary containing the working directory and excluded files and</span>
<span class="sd">        directories.</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="p">{</span>
        <span class="s2">&quot;working_dir&quot;</span><span class="p">:</span> <span class="nb">str</span><span class="p">(</span><span class="n">here</span><span class="p">()),</span>
        <span class="s2">&quot;excludes&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;data/&quot;</span><span class="p">,</span> <span class="s2">&quot;.git/&quot;</span><span class="p">,</span> <span class="s2">&quot;images/&quot;</span><span class="p">,</span> <span class="s2">&quot;core&quot;</span><span class="p">],</span>
    <span class="p">}</span></div>


<div class="viewcode-block" id="get_scheduler"><a class="viewcode-back" href="../../modules.html#aldernet.utils.get_scheduler">[docs]</a><span class="k">def</span> <span class="nf">get_scheduler</span><span class="p">(</span><span class="n">settings</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Get the scheduler for Ray Tune.</span>

<span class="sd">    Args:</span>
<span class="sd">        settings (dict): Dictionary of settings.</span>

<span class="sd">    Returns:</span>
<span class="sd">        ray.tune.schedulers.AsyncHyperBandScheduler: The scheduler for hyperparameter</span>
<span class="sd">        tuning.</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="n">ASHAScheduler</span><span class="p">(</span>
        <span class="n">time_attr</span><span class="o">=</span><span class="s2">&quot;training_iteration&quot;</span><span class="p">,</span>
        <span class="n">max_t</span><span class="o">=</span><span class="n">settings</span><span class="p">[</span><span class="s2">&quot;epochs&quot;</span><span class="p">],</span>
        <span class="n">grace_period</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
        <span class="n">reduction_factor</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span>
    <span class="p">)</span></div>


<div class="viewcode-block" id="get_tune_config"><a class="viewcode-back" href="../../modules.html#aldernet.utils.get_tune_config">[docs]</a><span class="k">def</span> <span class="nf">get_tune_config</span><span class="p">():</span>
    <span class="sd">&quot;&quot;&quot;Get the configuration settings for Ray Tune.</span>

<span class="sd">    Args:</span>
<span class="sd">        None</span>

<span class="sd">    Returns:</span>
<span class="sd">        dict: A dictionary containing the learning rate, beta values, and MLflow</span>
<span class="sd">        settings.</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="p">{</span>
        <span class="s2">&quot;learning_rate&quot;</span><span class="p">:</span> <span class="n">tune</span><span class="o">.</span><span class="n">choice</span><span class="p">([</span><span class="mf">0.001</span><span class="p">]),</span>
        <span class="s2">&quot;beta_1&quot;</span><span class="p">:</span> <span class="n">tune</span><span class="o">.</span><span class="n">choice</span><span class="p">([</span><span class="mf">0.9</span><span class="p">,</span> <span class="mf">0.95</span><span class="p">]),</span>
        <span class="s2">&quot;beta_2&quot;</span><span class="p">:</span> <span class="n">tune</span><span class="o">.</span><span class="n">choice</span><span class="p">([</span><span class="mf">0.98</span><span class="p">,</span> <span class="mf">0.99</span><span class="p">]),</span>
        <span class="s2">&quot;mlflow&quot;</span><span class="p">:</span> <span class="p">{</span>
            <span class="s2">&quot;experiment_name&quot;</span><span class="p">:</span> <span class="s2">&quot;Aldernet&quot;</span><span class="p">,</span>
            <span class="s2">&quot;tracking_uri&quot;</span><span class="p">:</span> <span class="n">mlflow</span><span class="o">.</span><span class="n">get_tracking_uri</span><span class="p">(),</span>
        <span class="p">},</span>
    <span class="p">}</span></div>


<div class="viewcode-block" id="get_callbacks"><a class="viewcode-back" href="../../modules.html#aldernet.utils.get_callbacks">[docs]</a><span class="k">def</span> <span class="nf">get_callbacks</span><span class="p">(</span><span class="n">run_path</span><span class="p">,</span> <span class="n">sha</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Get the MLflow logger callback for logging the experiment results.</span>

<span class="sd">    Args:</span>
<span class="sd">        run_path (str): Path to the output directory for storing results. sha (str): A</span>
<span class="sd">        string containing the Git commit hash for the current code.</span>

<span class="sd">    Returns:</span>
<span class="sd">        list: A list containing the MLflow logger callback.</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="p">[</span>
        <span class="n">MLflowLoggerCallback</span><span class="p">(</span>
            <span class="n">experiment_name</span><span class="o">=</span><span class="s2">&quot;Aldernet&quot;</span><span class="p">,</span>
            <span class="n">tags</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;git_commit&quot;</span><span class="p">:</span> <span class="n">sha</span><span class="p">},</span>
            <span class="n">tracking_uri</span><span class="o">=</span><span class="n">run_path</span> <span class="o">+</span> <span class="s2">&quot;/mlruns&quot;</span><span class="p">,</span>
            <span class="n">save_artifact</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
        <span class="p">)</span>
    <span class="p">]</span></div>


<div class="viewcode-block" id="rsync_mlruns"><a class="viewcode-back" href="../../modules.html#aldernet.utils.rsync_mlruns">[docs]</a><span class="k">def</span> <span class="nf">rsync_mlruns</span><span class="p">(</span><span class="n">run_path</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Copy the MLflow run data to the current working directory.</span>

<span class="sd">    Args:</span>
<span class="sd">        run_path (str): Path to the output directory for storing results.</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">rsync_cmd</span> <span class="o">=</span> <span class="s2">&quot;rsync&quot;</span> <span class="o">+</span> <span class="s2">&quot; -avzh &quot;</span> <span class="o">+</span> <span class="n">run_path</span> <span class="o">+</span> <span class="s2">&quot;/mlruns&quot;</span> <span class="o">+</span> <span class="s2">&quot; &quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">here</span><span class="p">())</span>
    <span class="n">subprocess</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">rsync_cmd</span><span class="p">,</span> <span class="n">shell</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">check</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span></div>


<div class="viewcode-block" id="train_without_ray_tune"><a class="viewcode-back" href="../../modules.html#aldernet.utils.train_without_ray_tune">[docs]</a><span class="k">def</span> <span class="nf">train_without_ray_tune</span><span class="p">(</span><span class="n">settings</span><span class="p">,</span> <span class="n">data_train</span><span class="p">,</span> <span class="n">data_valid</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Train a neural network model without using Ray Tune for hyperparameter tuning.</span>

<span class="sd">    Args:</span>
<span class="sd">        settings (dict): Dictionary of settings. data_train (xarray.Dataset): Training</span>
<span class="sd">        data. data_valid (xarray.Dataset): Validation data.</span>

<span class="sd">    Returns:</span>
<span class="sd">        tensorflow.python.keras.engine.functional.Functional: The trained neural network</span>
<span class="sd">        model.</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">batcher_train</span> <span class="o">=</span> <span class="n">Batcher</span><span class="p">(</span>
        <span class="n">data_train</span><span class="p">,</span>
        <span class="n">batch_size</span><span class="o">=</span><span class="mi">32</span><span class="p">,</span>
        <span class="n">add_weather</span><span class="o">=</span><span class="n">settings</span><span class="p">[</span><span class="s2">&quot;add_weather&quot;</span><span class="p">],</span>
        <span class="n">shuffle</span><span class="o">=</span><span class="n">settings</span><span class="p">[</span><span class="s2">&quot;shuffle&quot;</span><span class="p">],</span>
    <span class="p">)</span>
    <span class="n">batcher_valid</span> <span class="o">=</span> <span class="n">Batcher</span><span class="p">(</span>
        <span class="n">data_valid</span><span class="p">,</span>
        <span class="n">batch_size</span><span class="o">=</span><span class="mi">32</span><span class="p">,</span>
        <span class="n">add_weather</span><span class="o">=</span><span class="n">settings</span><span class="p">[</span><span class="s2">&quot;add_weather&quot;</span><span class="p">],</span>
        <span class="n">shuffle</span><span class="o">=</span><span class="n">settings</span><span class="p">[</span><span class="s2">&quot;shuffle&quot;</span><span class="p">],</span>
    <span class="p">)</span>
    <span class="n">simple_model</span> <span class="o">=</span> <span class="n">train_model_simple</span><span class="p">(</span>
        <span class="n">batcher_train</span><span class="p">,</span>
        <span class="n">batcher_valid</span><span class="p">,</span>
        <span class="n">epochs</span><span class="o">=</span><span class="n">settings</span><span class="p">[</span><span class="s2">&quot;epochs&quot;</span><span class="p">],</span>
        <span class="n">add_weather</span><span class="o">=</span><span class="n">settings</span><span class="p">[</span><span class="s2">&quot;add_weather&quot;</span><span class="p">],</span>
        <span class="n">conv</span><span class="o">=</span><span class="n">settings</span><span class="p">[</span><span class="s2">&quot;conv&quot;</span><span class="p">],</span>
    <span class="p">)</span>
    <span class="k">return</span> <span class="n">simple_model</span></div>


<div class="viewcode-block" id="load_pretrained_model"><a class="viewcode-back" href="../../modules.html#aldernet.utils.load_pretrained_model">[docs]</a><span class="k">def</span> <span class="nf">load_pretrained_model</span><span class="p">():</span>
    <span class="sd">&quot;&quot;&quot;Load a pretrained neural network model.</span>

<span class="sd">    Returns:</span>
<span class="sd">        tensorflow.python.keras.engine.functional.Functional: The pretrained neural</span>
<span class="sd">        network model.</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="n">Checkpoint</span><span class="o">.</span><span class="n">from_directory</span><span class="p">(</span>
        <span class="s2">&quot;/users/sadamov/pyprojects/aldernet/output/20230228_114607/train_model_2023-&quot;</span>
        <span class="s2">&quot;02-28_11-46-32/train_model_29eef_00000_0_beta_1=0.9500,beta_2=0.9800,&quot;</span>
        <span class="s2">&quot;learning_rate=0.0010_2023-02-28_11-46-51/checkpoint_000000&quot;</span>
    <span class="p">)</span><span class="o">.</span><span class="n">to_dict</span><span class="p">()[</span><span class="s2">&quot;model&quot;</span><span class="p">]</span></div>


<div class="viewcode-block" id="save_predictions_and_generate_report"><a class="viewcode-back" href="../../modules.html#aldernet.utils.save_predictions_and_generate_report">[docs]</a><span class="k">def</span> <span class="nf">save_predictions_and_generate_report</span><span class="p">(</span><span class="n">settings</span><span class="p">,</span> <span class="n">best_model</span><span class="p">,</span> <span class="n">data_valid</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Save the predicted and observed values to a CSV file and generate a report.</span>

<span class="sd">    Args:</span>
<span class="sd">        settings (dict): Dictionary of settings.</span>
<span class="sd">        best_model(tensorflow.python.keras.engine.functional.Functional): The trained</span>
<span class="sd">        neural network model.</span>
<span class="sd">        data_valid (xarray.Dataset): Validation data.</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">predictions</span> <span class="o">=</span> <span class="n">predict_season</span><span class="p">(</span>
        <span class="n">best_model</span><span class="p">,</span> <span class="n">data_valid</span><span class="p">,</span> <span class="n">settings</span><span class="p">[</span><span class="s2">&quot;noise_dim&quot;</span><span class="p">],</span> <span class="n">settings</span><span class="p">[</span><span class="s2">&quot;add_weather&quot;</span><span class="p">]</span>
    <span class="p">)</span>
    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">here</span><span class="p">())</span> <span class="o">+</span> <span class="s2">&quot;/data/scaling.txt&quot;</span><span class="p">,</span> <span class="s2">&quot;r&quot;</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="s2">&quot;utf-8&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
        <span class="n">lines</span> <span class="o">=</span> <span class="p">[</span><span class="n">line</span><span class="o">.</span><span class="n">rstrip</span><span class="p">()</span> <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">f</span><span class="p">]</span>
        <span class="n">center</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">lines</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot; &quot;</span><span class="p">)[</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>
        <span class="n">scale</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">lines</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot; &quot;</span><span class="p">)[</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>

    <span class="n">data_valid</span><span class="p">[</span><span class="n">settings</span><span class="p">[</span><span class="s2">&quot;target_species&quot;</span><span class="p">]]</span> <span class="o">=</span> <span class="p">(</span><span class="n">data_valid</span><span class="o">.</span><span class="n">dims</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">squeeze</span><span class="p">(</span><span class="n">predictions</span><span class="p">))</span>
    <span class="n">data_valid_out</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">maximum</span><span class="p">(</span>
        <span class="mi">0</span><span class="p">,</span> <span class="n">data_valid</span><span class="p">[</span><span class="n">settings</span><span class="p">[</span><span class="s2">&quot;target_species&quot;</span><span class="p">]]</span> <span class="o">*</span> <span class="n">scale</span> <span class="o">+</span> <span class="n">center</span>
    <span class="p">)</span>
    <span class="n">data_valid_out</span><span class="o">.</span><span class="n">to_netcdf</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">here</span><span class="p">())</span> <span class="o">+</span> <span class="s2">&quot;/data/pollen_ml.nc&quot;</span><span class="p">)</span>  <span class="c1"># type: ignore</span>

    <span class="k">if</span> <span class="n">settings</span><span class="p">[</span><span class="s2">&quot;target_species&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;ALNU&quot;</span><span class="p">:</span>
        <span class="n">target_species_name</span> <span class="o">=</span> <span class="s2">&quot;Alnus&quot;</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">target_species_name</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>

    <span class="n">station_values</span> <span class="o">=</span> <span class="n">data_valid_out</span><span class="o">.</span><span class="n">values</span><span class="p">[</span>  <span class="c1"># type:ignore</span>
        <span class="p">:,</span> <span class="n">Stations</span><span class="p">()</span><span class="o">.</span><span class="n">grids</span><span class="p">[</span><span class="s2">&quot;grid_j&quot;</span><span class="p">],</span> <span class="n">Stations</span><span class="p">()</span><span class="o">.</span><span class="n">grids</span><span class="p">[</span><span class="s2">&quot;grid_i&quot;</span><span class="p">]</span>
    <span class="p">]</span>
    <span class="n">data_pd</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">(</span>
        <span class="p">[</span>
            <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span>
                <span class="p">{</span><span class="s2">&quot;datetime&quot;</span><span class="p">:</span> <span class="n">data_valid</span><span class="o">.</span><span class="n">valid_time</span><span class="o">.</span><span class="n">values</span><span class="p">,</span> <span class="s2">&quot;taxon&quot;</span><span class="p">:</span> <span class="n">target_species_name</span><span class="p">}</span>
            <span class="p">),</span>
            <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">station_values</span><span class="p">),</span>
        <span class="p">],</span>
        <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
    <span class="p">)</span>

    <span class="n">data_pd</span><span class="o">.</span><span class="n">columns</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;datetime&quot;</span><span class="p">,</span> <span class="s2">&quot;taxon&quot;</span><span class="p">]</span> <span class="o">+</span> <span class="n">Stations</span><span class="p">()</span><span class="o">.</span><span class="n">name</span>  <span class="c1"># type: ignore</span>
    <span class="n">data_pd</span><span class="o">.</span><span class="n">to_csv</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">here</span><span class="p">())</span> <span class="o">+</span> <span class="s2">&quot;/data/pollen_ml.atab&quot;</span><span class="p">,</span> <span class="n">sep</span><span class="o">=</span><span class="s2">&quot;,&quot;</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span></div>


<div class="viewcode-block" id="generate_report"><a class="viewcode-back" href="../../modules.html#aldernet.utils.generate_report">[docs]</a><span class="k">def</span> <span class="nf">generate_report</span><span class="p">(</span><span class="n">df</span><span class="p">,</span> <span class="n">settings</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Generate a report summarizing the experiment results.</span>

<span class="sd">    Args:</span>
<span class="sd">        df (pandas.core.frame.DataFrame): A dataframe containing the predicted and</span>
<span class="sd">        observed values.</span>
<span class="sd">        settings (dict): Dictionary of settings.</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">report_path</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">here</span><span class="p">())</span> <span class="o">+</span> <span class="s2">&quot;/output/report.txt&quot;</span>
    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">report_path</span><span class="p">,</span> <span class="s2">&quot;w&quot;</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="s2">&quot;utf-8&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">report</span><span class="p">:</span>
        <span class="n">report</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;Training settings:</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">settings</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="n">report</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">key</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">value</span><span class="si">}</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="n">report</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Predictions and observed values:</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="n">report</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">to_string</span><span class="p">())</span></div>


<div class="viewcode-block" id="define_filters"><a class="viewcode-back" href="../../modules.html#aldernet.utils.define_filters">[docs]</a><span class="k">def</span> <span class="nf">define_filters</span><span class="p">(</span><span class="n">zoom</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Define the filters for the generator model based on the specified zoom level.</span>

<span class="sd">    Args:</span>
<span class="sd">        zoom (str): The zoom level.</span>

<span class="sd">    Returns:</span>
<span class="sd">        list: A list containing the filter values for the generator model.</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">filters</span> <span class="o">=</span> <span class="p">[</span><span class="mi">64</span><span class="p">,</span> <span class="mi">128</span><span class="p">,</span> <span class="mi">256</span><span class="p">,</span> <span class="mi">512</span><span class="p">,</span> <span class="mi">1024</span><span class="p">,</span> <span class="mi">1024</span><span class="p">,</span> <span class="mi">512</span><span class="p">,</span> <span class="mi">768</span><span class="p">,</span> <span class="mi">640</span><span class="p">,</span> <span class="mi">448</span><span class="p">,</span> <span class="mi">288</span><span class="p">,</span> <span class="mi">352</span><span class="p">]</span>

    <span class="k">if</span> <span class="n">zoom</span> <span class="o">==</span> <span class="s2">&quot;&quot;</span><span class="p">:</span>
        <span class="n">filters</span><span class="p">[:]</span> <span class="o">=</span> <span class="p">[</span><span class="nb">int</span><span class="p">(</span><span class="n">x</span> <span class="o">/</span> <span class="mi">16</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">filters</span><span class="p">]</span>

    <span class="k">return</span> <span class="n">filters</span></div>


<div class="viewcode-block" id="tf_setup"><a class="viewcode-back" href="../../modules.html#aldernet.utils.tf_setup">[docs]</a><span class="k">def</span> <span class="nf">tf_setup</span><span class="p">():</span>
    <span class="sd">&quot;&quot;&quot;Set up Tensorflow to use GPU memory growth.&quot;&quot;&quot;</span>
    <span class="n">gpus</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">experimental</span><span class="o">.</span><span class="n">list_physical_devices</span><span class="p">(</span><span class="s2">&quot;GPU&quot;</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">gpus</span><span class="p">:</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">gpu</span> <span class="ow">in</span> <span class="n">gpus</span><span class="p">:</span>
                <span class="n">tf</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">experimental</span><span class="o">.</span><span class="n">set_memory_growth</span><span class="p">(</span><span class="n">gpu</span><span class="p">,</span> <span class="kc">True</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">RuntimeError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="n">e</span><span class="p">)</span></div>


<div class="viewcode-block" id="cbr"><a class="viewcode-back" href="../../modules.html#aldernet.utils.cbr">[docs]</a><span class="k">def</span> <span class="nf">cbr</span><span class="p">(</span><span class="n">filters</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Sequential</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;Construct a Convolution-BatchNorm-ReLU block using the Keras Sequential API.</span>

<span class="sd">    Args:</span>
<span class="sd">        filters (int): Number of filters in the Conv2D layer. name (str): Optional name</span>
<span class="sd">        for the block.</span>

<span class="sd">    Returns:</span>
<span class="sd">        Sequential: A Keras Sequential model representing the CBR block.</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">block</span> <span class="o">=</span> <span class="n">keras</span><span class="o">.</span><span class="n">Sequential</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="n">name</span><span class="p">)</span>
    <span class="n">block</span><span class="o">.</span><span class="n">add</span><span class="p">(</span>
        <span class="n">layers</span><span class="o">.</span><span class="n">Conv2D</span><span class="p">(</span>
            <span class="n">filters</span><span class="o">=</span><span class="n">filters</span><span class="p">,</span>
            <span class="n">kernel_size</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span>
            <span class="n">padding</span><span class="o">=</span><span class="s2">&quot;same&quot;</span><span class="p">,</span>
            <span class="n">use_bias</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
        <span class="p">)</span>
    <span class="p">)</span>
    <span class="n">block</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">layers</span><span class="o">.</span><span class="n">BatchNormalization</span><span class="p">())</span>
    <span class="n">block</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">layers</span><span class="o">.</span><span class="n">LeakyReLU</span><span class="p">())</span>

    <span class="k">return</span> <span class="n">block</span></div>


<div class="viewcode-block" id="down"><a class="viewcode-back" href="../../modules.html#aldernet.utils.down">[docs]</a><span class="k">def</span> <span class="nf">down</span><span class="p">(</span><span class="n">filters</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Sequential</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;Construct a down-sampling block using the Keras Sequential API.</span>

<span class="sd">    Args:</span>
<span class="sd">        filters (int): Number of filters in the Conv2D layer. name (str): Optional name</span>
<span class="sd">        for the block.</span>

<span class="sd">    Returns:</span>
<span class="sd">        Sequential: A Keras Sequential model representing the down-sampling block.</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">block</span> <span class="o">=</span> <span class="n">keras</span><span class="o">.</span><span class="n">Sequential</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="n">name</span><span class="p">)</span>
    <span class="n">block</span><span class="o">.</span><span class="n">add</span><span class="p">(</span>
        <span class="n">layers</span><span class="o">.</span><span class="n">Conv2D</span><span class="p">(</span>
            <span class="n">filters</span><span class="o">=</span><span class="n">filters</span><span class="p">,</span>
            <span class="n">kernel_size</span><span class="o">=</span><span class="mi">4</span><span class="p">,</span>
            <span class="n">strides</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span>
            <span class="n">padding</span><span class="o">=</span><span class="s2">&quot;same&quot;</span><span class="p">,</span>
            <span class="n">use_bias</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
        <span class="p">)</span>
    <span class="p">)</span>
    <span class="n">block</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">layers</span><span class="o">.</span><span class="n">BatchNormalization</span><span class="p">())</span>
    <span class="n">block</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">layers</span><span class="o">.</span><span class="n">LeakyReLU</span><span class="p">())</span>
    <span class="c1"># block.add(layers.MaxPooling2D((2, 2), padding=&quot;same&quot;))</span>
    <span class="c1"># block.add(layers.Dropout(0.05))</span>

    <span class="k">return</span> <span class="n">block</span></div>


<div class="viewcode-block" id="up"><a class="viewcode-back" href="../../modules.html#aldernet.utils.up">[docs]</a><span class="k">def</span> <span class="nf">up</span><span class="p">(</span><span class="n">filters</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Sequential</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;Construct an up-sampling block using the Keras Sequential API.</span>

<span class="sd">    Args:</span>
<span class="sd">        filters (int): Number of filters in the Conv2DTranspose layer. name (str):</span>
<span class="sd">        Optional name for the block.</span>

<span class="sd">    Returns:</span>
<span class="sd">        Sequential: A Keras Sequential model representing the up-sampling block.</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">block</span> <span class="o">=</span> <span class="n">keras</span><span class="o">.</span><span class="n">Sequential</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="n">name</span><span class="p">)</span>
    <span class="n">block</span><span class="o">.</span><span class="n">add</span><span class="p">(</span>
        <span class="n">layers</span><span class="o">.</span><span class="n">Conv2DTranspose</span><span class="p">(</span>
            <span class="n">filters</span><span class="o">=</span><span class="n">filters</span><span class="p">,</span>
            <span class="n">kernel_size</span><span class="o">=</span><span class="mi">4</span><span class="p">,</span>
            <span class="n">strides</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span>
            <span class="n">padding</span><span class="o">=</span><span class="s2">&quot;same&quot;</span><span class="p">,</span>
            <span class="n">use_bias</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
        <span class="p">)</span>
    <span class="p">)</span>
    <span class="n">block</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">layers</span><span class="o">.</span><span class="n">BatchNormalization</span><span class="p">())</span>
    <span class="n">block</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">layers</span><span class="o">.</span><span class="n">LeakyReLU</span><span class="p">())</span>

    <span class="k">return</span> <span class="n">block</span></div>


<div class="viewcode-block" id="compile_generator"><a class="viewcode-back" href="../../modules.html#aldernet.utils.compile_generator">[docs]</a><span class="k">def</span> <span class="nf">compile_generator</span><span class="p">(</span><span class="n">height</span><span class="p">,</span> <span class="n">width</span><span class="p">,</span> <span class="n">weather_features</span><span class="p">,</span> <span class="n">noise_dim</span><span class="p">,</span> <span class="n">filters</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Compile a generator model for image-to-image translation using Keras API.</span>

<span class="sd">    Args:</span>
<span class="sd">        height (int): Height of the input images. width (int): Width of the input</span>
<span class="sd">        images. weather_features (int): Number of weather features in the weather input.</span>
<span class="sd">        noise_dim (int): Dimensionality of the noise input. filters (List[int]): Number</span>
<span class="sd">        of filters in each layer of the generator.</span>

<span class="sd">    Returns:</span>
<span class="sd">        Model: A Keras Model representing the compiled generator model.</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">image_input</span> <span class="o">=</span> <span class="n">keras</span><span class="o">.</span><span class="n">Input</span><span class="p">(</span><span class="n">shape</span><span class="o">=</span><span class="p">[</span><span class="n">height</span><span class="p">,</span> <span class="n">width</span><span class="p">,</span> <span class="mi">1</span><span class="p">],</span> <span class="n">name</span><span class="o">=</span><span class="s2">&quot;image_input&quot;</span><span class="p">)</span>
    <span class="n">noise_input</span> <span class="o">=</span> <span class="n">weather_input</span> <span class="o">=</span> <span class="n">keras</span><span class="o">.</span><span class="n">Input</span><span class="p">(</span><span class="n">shape</span><span class="o">=</span><span class="p">[])</span>
    <span class="k">if</span> <span class="n">weather_features</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">weather_input</span> <span class="o">=</span> <span class="n">keras</span><span class="o">.</span><span class="n">Input</span><span class="p">(</span>
            <span class="n">shape</span><span class="o">=</span><span class="p">[</span><span class="n">height</span><span class="p">,</span> <span class="n">width</span><span class="p">,</span> <span class="n">weather_features</span><span class="p">],</span> <span class="n">name</span><span class="o">=</span><span class="s2">&quot;weather_input&quot;</span>
        <span class="p">)</span>
        <span class="n">inputs</span> <span class="o">=</span> <span class="n">layers</span><span class="o">.</span><span class="n">Concatenate</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s2">&quot;inputs-concat&quot;</span><span class="p">)([</span><span class="n">image_input</span><span class="p">,</span> <span class="n">weather_input</span><span class="p">])</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">inputs</span> <span class="o">=</span> <span class="n">image_input</span>
    <span class="n">block</span> <span class="o">=</span> <span class="n">cbr</span><span class="p">(</span><span class="n">filters</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="s2">&quot;pre-cbr-1&quot;</span><span class="p">)(</span><span class="n">inputs</span><span class="p">)</span>

    <span class="n">u_skip_layers</span> <span class="o">=</span> <span class="p">[</span><span class="n">block</span><span class="p">]</span>
    <span class="k">for</span> <span class="n">ll</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">filters</span><span class="p">)</span> <span class="o">//</span> <span class="mi">2</span><span class="p">):</span>
        <span class="n">block</span> <span class="o">=</span> <span class="n">down</span><span class="p">(</span><span class="n">filters</span><span class="p">[</span><span class="n">ll</span><span class="p">],</span> <span class="sa">f</span><span class="s2">&quot;down_</span><span class="si">{</span><span class="n">ll</span><span class="si">}</span><span class="s2">-down&quot;</span><span class="p">)(</span><span class="n">block</span><span class="p">)</span>
        <span class="c1"># Collect U-Net skip connections</span>
        <span class="n">u_skip_layers</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">block</span><span class="p">)</span>
    <span class="n">height</span> <span class="o">=</span> <span class="n">block</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
    <span class="n">width</span> <span class="o">=</span> <span class="n">block</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>
    <span class="k">if</span> <span class="n">noise_dim</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">noise_channels</span> <span class="o">=</span> <span class="mi">128</span>
        <span class="n">noise_input</span> <span class="o">=</span> <span class="n">keras</span><span class="o">.</span><span class="n">Input</span><span class="p">(</span><span class="n">shape</span><span class="o">=</span><span class="n">noise_dim</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s2">&quot;noise_input&quot;</span><span class="p">)</span>
        <span class="n">noise</span> <span class="o">=</span> <span class="n">layers</span><span class="o">.</span><span class="n">Dense</span><span class="p">(</span>
            <span class="n">height</span> <span class="o">*</span> <span class="n">width</span> <span class="o">*</span> <span class="n">noise_channels</span><span class="p">,</span>
        <span class="p">)(</span><span class="n">noise_input</span><span class="p">)</span>
        <span class="n">noise</span> <span class="o">=</span> <span class="n">layers</span><span class="o">.</span><span class="n">Reshape</span><span class="p">((</span><span class="n">height</span><span class="p">,</span> <span class="n">width</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">))(</span><span class="n">noise</span><span class="p">)</span>
        <span class="n">block</span> <span class="o">=</span> <span class="n">layers</span><span class="o">.</span><span class="n">Concatenate</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s2">&quot;add-noise&quot;</span><span class="p">)([</span><span class="n">block</span><span class="p">,</span> <span class="n">noise</span><span class="p">])</span>
    <span class="n">u_skip_layers</span><span class="o">.</span><span class="n">pop</span><span class="p">()</span>

    <span class="k">for</span> <span class="n">ll</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">filters</span><span class="p">)</span> <span class="o">//</span> <span class="mi">2</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">filters</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">):</span>
        <span class="n">block</span> <span class="o">=</span> <span class="n">up</span><span class="p">(</span><span class="n">filters</span><span class="p">[</span><span class="n">ll</span><span class="p">],</span> <span class="sa">f</span><span class="s2">&quot;up_</span><span class="si">{</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">filters</span><span class="p">)</span> <span class="o">-</span> <span class="n">ll</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span><span class="si">}</span><span class="s2">-up&quot;</span><span class="p">)(</span><span class="n">block</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">block</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="nb">slice</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">)]</span> <span class="o">!=</span> <span class="n">u_skip_layers</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="nb">slice</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">)]:</span>
            <span class="n">block</span> <span class="o">=</span> <span class="n">layers</span><span class="o">.</span><span class="n">Cropping2D</span><span class="p">(</span><span class="n">cropping</span><span class="o">=</span><span class="p">((</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span> <span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">)),</span> <span class="n">data_format</span><span class="o">=</span><span class="kc">None</span><span class="p">)(</span>
                <span class="n">block</span>
            <span class="p">)</span>
        <span class="c1"># Connect U-Net skip</span>
        <span class="n">block</span> <span class="o">=</span> <span class="n">layers</span><span class="o">.</span><span class="n">Concatenate</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;up_</span><span class="si">{</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">filters</span><span class="p">)</span> <span class="o">-</span> <span class="n">ll</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span><span class="si">}</span><span class="s2">-concatenate&quot;</span><span class="p">)(</span>
            <span class="p">[</span><span class="n">block</span><span class="p">,</span> <span class="n">u_skip_layers</span><span class="o">.</span><span class="n">pop</span><span class="p">()]</span>
        <span class="p">)</span>

    <span class="n">block</span> <span class="o">=</span> <span class="n">cbr</span><span class="p">(</span><span class="n">filters</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="s2">&quot;post-cbr-1&quot;</span><span class="p">)(</span><span class="n">block</span><span class="p">)</span>

    <span class="n">pollen</span> <span class="o">=</span> <span class="n">layers</span><span class="o">.</span><span class="n">Conv2D</span><span class="p">(</span>
        <span class="n">filters</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
        <span class="n">kernel_size</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
        <span class="n">padding</span><span class="o">=</span><span class="s2">&quot;same&quot;</span><span class="p">,</span>
        <span class="n">activation</span><span class="o">=</span><span class="s2">&quot;tanh&quot;</span><span class="p">,</span>
        <span class="n">name</span><span class="o">=</span><span class="s2">&quot;output&quot;</span><span class="p">,</span>
    <span class="p">)(</span><span class="n">block</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">weather_features</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="ow">and</span> <span class="n">noise_dim</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">tf</span><span class="o">.</span><span class="n">keras</span><span class="o">.</span><span class="n">Model</span><span class="p">(</span>
            <span class="n">inputs</span><span class="o">=</span><span class="p">[</span><span class="n">noise_input</span><span class="p">,</span> <span class="n">image_input</span><span class="p">,</span> <span class="n">weather_input</span><span class="p">],</span> <span class="n">outputs</span><span class="o">=</span><span class="n">pollen</span>
        <span class="p">)</span>
    <span class="k">elif</span> <span class="n">noise_dim</span> <span class="o">&lt;=</span> <span class="mi">0</span> <span class="o">&lt;</span> <span class="n">weather_features</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">tf</span><span class="o">.</span><span class="n">keras</span><span class="o">.</span><span class="n">Model</span><span class="p">(</span><span class="n">inputs</span><span class="o">=</span><span class="p">[</span><span class="n">image_input</span><span class="p">,</span> <span class="n">weather_input</span><span class="p">],</span> <span class="n">outputs</span><span class="o">=</span><span class="n">pollen</span><span class="p">)</span>
    <span class="k">elif</span> <span class="n">weather_features</span> <span class="o">&lt;=</span> <span class="mi">0</span> <span class="o">&lt;</span> <span class="n">noise_dim</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">tf</span><span class="o">.</span><span class="n">keras</span><span class="o">.</span><span class="n">Model</span><span class="p">(</span><span class="n">inputs</span><span class="o">=</span><span class="p">[</span><span class="n">noise_input</span><span class="p">,</span> <span class="n">image_input</span><span class="p">],</span> <span class="n">outputs</span><span class="o">=</span><span class="n">pollen</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">tf</span><span class="o">.</span><span class="n">keras</span><span class="o">.</span><span class="n">Model</span><span class="p">(</span><span class="n">inputs</span><span class="o">=</span><span class="p">[</span><span class="n">image_input</span><span class="p">],</span> <span class="n">outputs</span><span class="o">=</span><span class="n">pollen</span><span class="p">)</span></div>


<div class="viewcode-block" id="write_png"><a class="viewcode-back" href="../../modules.html#aldernet.utils.write_png">[docs]</a><span class="k">def</span> <span class="nf">write_png</span><span class="p">(</span><span class="n">image</span><span class="p">,</span> <span class="n">path</span><span class="p">,</span> <span class="n">pretty</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Write an image in PNG format to a file.</span>

<span class="sd">    Args:</span>
<span class="sd">        image (Tensor): A 3-tuple of Tensors representing the input, target, and</span>
<span class="sd">        predicted images. path (str): Path to the output file. pretty (bool): Whether to</span>
<span class="sd">        create a pretty visualization of the image.</span>

<span class="sd">    Returns:</span>
<span class="sd">        None</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">pretty</span><span class="p">:</span>
        <span class="n">minmin</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">image</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">min</span><span class="p">(),</span> <span class="n">image</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">min</span><span class="p">(),</span> <span class="n">image</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">min</span><span class="p">())</span>
        <span class="n">maxmax</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="nb">max</span><span class="p">(</span><span class="n">image</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">max</span><span class="p">(),</span> <span class="n">image</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">max</span><span class="p">(),</span> <span class="n">image</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">max</span><span class="p">()),</span> <span class="mi">500</span><span class="p">)</span>

        <span class="n">fig</span><span class="p">,</span> <span class="p">(</span><span class="n">ax1</span><span class="p">,</span> <span class="n">ax2</span><span class="p">,</span> <span class="n">ax3</span><span class="p">)</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="mf">2.1</span><span class="p">),</span> <span class="n">dpi</span><span class="o">=</span><span class="mi">150</span><span class="p">)</span>
        <span class="n">ax1</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span>
            <span class="n">image</span><span class="p">[</span><span class="mi">0</span><span class="p">][:,</span> <span class="p">:,</span> <span class="mi">0</span><span class="p">],</span> <span class="n">cmap</span><span class="o">=</span><span class="s2">&quot;viridis&quot;</span><span class="p">,</span> <span class="n">vmin</span><span class="o">=</span><span class="n">minmin</span><span class="p">,</span> <span class="n">vmax</span><span class="o">=</span><span class="n">maxmax</span><span class="p">,</span> <span class="n">aspect</span><span class="o">=</span><span class="s2">&quot;auto&quot;</span>
        <span class="p">)</span>
        <span class="n">ax2</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span>
            <span class="n">image</span><span class="p">[</span><span class="mi">1</span><span class="p">][:,</span> <span class="p">:,</span> <span class="mi">0</span><span class="p">],</span> <span class="n">cmap</span><span class="o">=</span><span class="s2">&quot;viridis&quot;</span><span class="p">,</span> <span class="n">vmin</span><span class="o">=</span><span class="n">minmin</span><span class="p">,</span> <span class="n">vmax</span><span class="o">=</span><span class="n">maxmax</span><span class="p">,</span> <span class="n">aspect</span><span class="o">=</span><span class="s2">&quot;auto&quot;</span>
        <span class="p">)</span>
        <span class="n">im3</span> <span class="o">=</span> <span class="n">ax3</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span>
            <span class="n">image</span><span class="p">[</span><span class="mi">2</span><span class="p">][:,</span> <span class="p">:,</span> <span class="mi">0</span><span class="p">],</span> <span class="n">cmap</span><span class="o">=</span><span class="s2">&quot;viridis&quot;</span><span class="p">,</span> <span class="n">vmin</span><span class="o">=</span><span class="n">minmin</span><span class="p">,</span> <span class="n">vmax</span><span class="o">=</span><span class="n">maxmax</span><span class="p">,</span> <span class="n">aspect</span><span class="o">=</span><span class="s2">&quot;auto&quot;</span>
        <span class="p">)</span>
        <span class="k">for</span> <span class="n">ax</span> <span class="ow">in</span> <span class="p">(</span><span class="n">ax1</span><span class="p">,</span> <span class="n">ax2</span><span class="p">,</span> <span class="n">ax3</span><span class="p">):</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">axes</span><span class="o">.</span><span class="n">xaxis</span><span class="o">.</span><span class="n">set_visible</span><span class="p">(</span><span class="kc">False</span><span class="p">)</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">axes</span><span class="o">.</span><span class="n">yaxis</span><span class="o">.</span><span class="n">set_visible</span><span class="p">(</span><span class="kc">False</span><span class="p">)</span>
        <span class="n">ax1</span><span class="o">.</span><span class="n">axes</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s2">&quot;Input&quot;</span><span class="p">)</span>
        <span class="n">ax2</span><span class="o">.</span><span class="n">axes</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s2">&quot;Target&quot;</span><span class="p">)</span>
        <span class="n">ax3</span><span class="o">.</span><span class="n">axes</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s2">&quot;Prediction&quot;</span><span class="p">)</span>
        <span class="n">fig</span><span class="o">.</span><span class="n">subplots_adjust</span><span class="p">(</span><span class="n">right</span><span class="o">=</span><span class="mf">0.85</span><span class="p">,</span> <span class="n">top</span><span class="o">=</span><span class="mf">0.85</span><span class="p">)</span>
        <span class="n">cbar_ax</span> <span class="o">=</span> <span class="n">fig</span><span class="o">.</span><span class="n">add_axes</span><span class="p">([</span><span class="mf">0.88</span><span class="p">,</span> <span class="mf">0.15</span><span class="p">,</span> <span class="mf">0.04</span><span class="p">,</span> <span class="mf">0.7</span><span class="p">])</span>
        <span class="n">fig</span><span class="o">.</span><span class="n">colorbar</span><span class="p">(</span><span class="n">im3</span><span class="p">,</span> <span class="n">cax</span><span class="o">=</span><span class="n">cbar_ax</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">close</span><span class="p">(</span><span class="n">fig</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">image</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">concat</span><span class="p">(</span><span class="n">image</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="mi">10</span>
        <span class="n">image</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">cast</span><span class="p">(</span><span class="n">image</span><span class="p">,</span> <span class="n">tf</span><span class="o">.</span><span class="n">uint8</span><span class="p">)</span>
        <span class="n">png</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">image</span><span class="o">.</span><span class="n">encode_png</span><span class="p">(</span><span class="n">image</span><span class="p">)</span>
        <span class="n">tf</span><span class="o">.</span><span class="n">io</span><span class="o">.</span><span class="n">write_file</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="n">png</span><span class="p">)</span></div>


<div class="viewcode-block" id="train_step"><a class="viewcode-back" href="../../modules.html#aldernet.utils.train_step">[docs]</a><span class="k">def</span> <span class="nf">train_step</span><span class="p">(</span>  <span class="c1"># pylint: disable=R0913</span>
    <span class="n">generator</span><span class="p">,</span>
    <span class="n">optimizer_gen</span><span class="p">,</span>
    <span class="n">input_train</span><span class="p">,</span>
    <span class="n">target_train</span><span class="p">,</span>
    <span class="n">weather_train</span><span class="p">,</span>
    <span class="n">noise_dim</span><span class="p">,</span>
    <span class="n">add_weather</span><span class="p">,</span>
<span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Perform one training step of the generator of a NNet using the given inputs.</span>

<span class="sd">    Args:</span>
<span class="sd">        generator (Model): The Keras Model representing the generator. optimizer_gen</span>
<span class="sd">        (Optimizer): The optimizer for the generator. input_train (Tensor): The input</span>
<span class="sd">        tensor for the generator. target_train (Tensor): The target tensor for the</span>
<span class="sd">        generator. weather_train (Tensor): The weather tensor for the generator.</span>
<span class="sd">        noise_dim (int): Dimensionality of the noise input. add_weather (bool): Whether</span>
<span class="sd">        to add the weather input to the generator.</span>

<span class="sd">    Returns:</span>
<span class="sd">        float: The loss of the generator on the given inputs.</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">noise</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">normal</span><span class="p">(</span><span class="n">shape</span><span class="o">=</span><span class="p">[])</span>
    <span class="k">if</span> <span class="n">noise_dim</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">noise</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">normal</span><span class="p">([</span><span class="n">input_train</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">noise_dim</span><span class="p">])</span>
    <span class="k">with</span> <span class="n">tf</span><span class="o">.</span><span class="n">GradientTape</span><span class="p">()</span> <span class="k">as</span> <span class="n">tape_gen</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">add_weather</span> <span class="ow">and</span> <span class="n">noise_dim</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">generated</span> <span class="o">=</span> <span class="n">generator</span><span class="p">([</span><span class="n">noise</span><span class="p">,</span> <span class="n">input_train</span><span class="p">,</span> <span class="n">weather_train</span><span class="p">])</span>
        <span class="k">elif</span> <span class="n">add_weather</span> <span class="ow">and</span> <span class="n">noise_dim</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">generated</span> <span class="o">=</span> <span class="n">generator</span><span class="p">([</span><span class="n">input_train</span><span class="p">,</span> <span class="n">weather_train</span><span class="p">])</span>
        <span class="k">elif</span> <span class="ow">not</span> <span class="n">add_weather</span> <span class="ow">and</span> <span class="n">noise_dim</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">generated</span> <span class="o">=</span> <span class="n">generator</span><span class="p">([</span><span class="n">noise</span><span class="p">,</span> <span class="n">input_train</span><span class="p">])</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">generated</span> <span class="o">=</span> <span class="n">generator</span><span class="p">([</span><span class="n">input_train</span><span class="p">])</span>
        <span class="n">loss</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">math</span><span class="o">.</span><span class="n">reduce_mean</span><span class="p">(</span><span class="n">tf</span><span class="o">.</span><span class="n">math</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">generated</span> <span class="o">-</span> <span class="n">target_train</span><span class="p">))</span>
        <span class="c1"># loss = tf.math.reduce_mean(tf.math.squared_difference(generated, alder))</span>
        <span class="n">gradients_gen</span> <span class="o">=</span> <span class="n">tape_gen</span><span class="o">.</span><span class="n">gradient</span><span class="p">(</span><span class="n">loss</span><span class="p">,</span> <span class="n">generator</span><span class="o">.</span><span class="n">trainable_variables</span><span class="p">)</span>

    <span class="n">optimizer_gen</span><span class="o">.</span><span class="n">apply_gradients</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="n">gradients_gen</span><span class="p">,</span> <span class="n">generator</span><span class="o">.</span><span class="n">trainable_variables</span><span class="p">))</span>

    <span class="k">return</span> <span class="n">loss</span></div>


<div class="viewcode-block" id="create_batcher"><a class="viewcode-back" href="../../modules.html#aldernet.utils.create_batcher">[docs]</a><span class="k">def</span> <span class="nf">create_batcher</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">batch_size</span><span class="p">,</span> <span class="n">add_weather</span><span class="p">,</span> <span class="n">shuffle</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Create a Batcher object for the given data.</span>

<span class="sd">    Args:</span>
<span class="sd">        data (Tuple[Tensor]): A tuple of Tensors representing the input and target data.</span>
<span class="sd">        batch_size (int): Batch size for training. add_weather (bool): Whether to add</span>
<span class="sd">        weather data to the input. shuffle (bool): Whether to shuffle the data during</span>
<span class="sd">        training.</span>

<span class="sd">    Returns:</span>
<span class="sd">        Batcher: A Batcher object for the given data.</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="n">Batcher</span><span class="p">(</span>
        <span class="n">data</span><span class="p">,</span> <span class="n">batch_size</span><span class="o">=</span><span class="n">batch_size</span><span class="p">,</span> <span class="n">add_weather</span><span class="o">=</span><span class="n">add_weather</span><span class="p">,</span> <span class="n">shuffle</span><span class="o">=</span><span class="n">shuffle</span>
    <span class="p">)</span></div>


<div class="viewcode-block" id="setup_directories"><a class="viewcode-back" href="../../modules.html#aldernet.utils.setup_directories">[docs]</a><span class="k">def</span> <span class="nf">setup_directories</span><span class="p">(</span><span class="n">run_path</span><span class="p">,</span> <span class="n">tune_trial</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Set up the directory structure for saving visualization images.</span>

<span class="sd">    Args:</span>
<span class="sd">        run_path (str): Path to the run directory. tune_trial (str): Trial ID for</span>
<span class="sd">        hyperparameter tuning.</span>

<span class="sd">    Returns:</span>
<span class="sd">        None</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">Path</span><span class="p">(</span><span class="n">run_path</span> <span class="o">+</span> <span class="s2">&quot;/viz/&quot;</span> <span class="o">+</span> <span class="n">tune_trial</span><span class="p">)</span><span class="o">.</span><span class="n">mkdir</span><span class="p">(</span><span class="n">parents</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">exist_ok</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">Path</span><span class="p">(</span><span class="n">run_path</span> <span class="o">+</span> <span class="s2">&quot;/viz/valid/&quot;</span> <span class="o">+</span> <span class="n">tune_trial</span><span class="p">)</span><span class="o">.</span><span class="n">mkdir</span><span class="p">(</span><span class="n">parents</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">exist_ok</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span></div>


<div class="viewcode-block" id="read_scaling_data"><a class="viewcode-back" href="../../modules.html#aldernet.utils.read_scaling_data">[docs]</a><span class="k">def</span> <span class="nf">read_scaling_data</span><span class="p">():</span>
    <span class="sd">&quot;&quot;&quot;Read and returns the center and scale values from scaling.txt file.</span>

<span class="sd">    Returns:</span>
<span class="sd">        Tuple[float, float]: A tuple of center and scale values.</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">here</span><span class="p">())</span> <span class="o">+</span> <span class="s2">&quot;/data/scaling.txt&quot;</span><span class="p">,</span> <span class="s2">&quot;r&quot;</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="s2">&quot;utf-8&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
        <span class="n">lines</span> <span class="o">=</span> <span class="p">[</span><span class="n">line</span><span class="o">.</span><span class="n">rstrip</span><span class="p">()</span> <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">f</span><span class="p">]</span>
        <span class="n">center</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">lines</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;: &quot;</span><span class="p">)[</span><span class="mi">1</span><span class="p">])</span>
        <span class="n">scale</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">lines</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;: &quot;</span><span class="p">)[</span><span class="mi">1</span><span class="p">])</span>
    <span class="k">return</span> <span class="n">center</span><span class="p">,</span> <span class="n">scale</span></div>


<div class="viewcode-block" id="create_optimizer"><a class="viewcode-back" href="../../modules.html#aldernet.utils.create_optimizer">[docs]</a><span class="k">def</span> <span class="nf">create_optimizer</span><span class="p">(</span><span class="n">learning_rate</span><span class="p">,</span> <span class="n">beta_1</span><span class="p">,</span> <span class="n">beta_2</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Create and returns an Adam optimizer with given hyperparameters.</span>

<span class="sd">    Args:</span>
<span class="sd">        learning_rate (float): The learning rate for the optimizer. beta_1 (float): The</span>
<span class="sd">        exponential decay rate for the first moment estimates. beta_2 (float): The</span>
<span class="sd">        exponential decay rate for the second-moment estimates.</span>

<span class="sd">    Returns:</span>
<span class="sd">        tf.keras.optimizers.Optimizer: An instance of the Adam optimizer.</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="n">tf</span><span class="o">.</span><span class="n">keras</span><span class="o">.</span><span class="n">optimizers</span><span class="o">.</span><span class="n">Adam</span><span class="p">(</span>
        <span class="n">learning_rate</span><span class="o">=</span><span class="n">learning_rate</span><span class="p">,</span>
        <span class="n">beta_1</span><span class="o">=</span><span class="n">beta_1</span><span class="p">,</span>
        <span class="n">beta_2</span><span class="o">=</span><span class="n">beta_2</span><span class="p">,</span>
        <span class="n">epsilon</span><span class="o">=</span><span class="mf">1e-08</span><span class="p">,</span>
    <span class="p">)</span></div>


<div class="viewcode-block" id="train_epoch"><a class="viewcode-back" href="../../modules.html#aldernet.utils.train_epoch">[docs]</a><span class="k">def</span> <span class="nf">train_epoch</span><span class="p">(</span>
    <span class="n">generator</span><span class="p">,</span>
    <span class="n">optimizer_gen</span><span class="p">,</span>
    <span class="n">data_train</span><span class="p">,</span>
    <span class="n">noise_dim</span><span class="p">,</span>
    <span class="n">add_weather</span><span class="p">,</span>
    <span class="n">center</span><span class="p">,</span>
    <span class="n">scale</span><span class="p">,</span>
    <span class="n">epoch</span><span class="p">,</span>
    <span class="n">step</span><span class="p">,</span>
    <span class="n">run_path</span><span class="p">,</span>
    <span class="n">tune_trial</span><span class="p">,</span>
<span class="p">):</span>  <span class="c1"># pylint: disable=R0913,R0914</span>
    <span class="sd">&quot;&quot;&quot;Trains the generator for one epoch and returns the loss values.</span>

<span class="sd">    Args:</span>
<span class="sd">        generator (tf.keras.Model): The generator model. optimizer_gen</span>
<span class="sd">        (tf.keras.optimizers.Optimizer): The generator optimizer. data_train (Batcher):</span>
<span class="sd">        The training data batcher. noise_dim (int): The dimensionality of the noise</span>
<span class="sd">        vector. add_weather (bool): If True, the weather data is included in training.</span>
<span class="sd">        center (float): The center value for the scaling. scale (float): The scale value</span>
<span class="sd">        for the scaling. epoch (tf.Variable): The current epoch. step (tf.Variable): The</span>
<span class="sd">        current step. run_path (str): The path to the directory where the output files</span>
<span class="sd">        will be stored. tune_trial (str): The name of the current Tune trial.</span>

<span class="sd">    Returns:</span>
<span class="sd">        np.ndarray: An array of loss values.</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">start</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
    <span class="n">loss_report</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">math</span><span class="o">.</span><span class="n">floor</span><span class="p">(</span><span class="n">data_train</span><span class="o">.</span><span class="n">x</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">/</span> <span class="n">data_train</span><span class="o">.</span><span class="n">batch_size</span><span class="p">)):</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">add_weather</span><span class="p">:</span>
            <span class="n">hazel_train</span><span class="p">,</span> <span class="n">alder_train</span> <span class="o">=</span> <span class="n">data_train</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">hazel_train</span><span class="p">,</span> <span class="n">weather_train</span><span class="p">,</span> <span class="n">alder_train</span> <span class="o">=</span> <span class="n">data_train</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>

        <span class="nb">print</span><span class="p">(</span><span class="n">epoch</span><span class="o">.</span><span class="n">numpy</span><span class="p">(),</span> <span class="s2">&quot;-&quot;</span><span class="p">,</span> <span class="n">step</span><span class="o">.</span><span class="n">numpy</span><span class="p">(),</span> <span class="n">flush</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">add_weather</span><span class="p">:</span>
            <span class="n">loss_report</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                <span class="n">loss_report</span><span class="p">,</span>
                <span class="n">train_step</span><span class="p">(</span>
                    <span class="n">generator</span><span class="p">,</span>
                    <span class="n">optimizer_gen</span><span class="p">,</span>
                    <span class="n">hazel_train</span><span class="p">,</span>
                    <span class="n">alder_train</span><span class="p">,</span>
                    <span class="n">weather_train</span> <span class="k">if</span> <span class="n">add_weather</span> <span class="k">else</span> <span class="kc">None</span><span class="p">,</span>
                    <span class="n">noise_dim</span><span class="p">,</span>
                    <span class="n">add_weather</span><span class="p">,</span>
                <span class="p">)</span><span class="o">.</span><span class="n">numpy</span><span class="p">(),</span>
            <span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">loss_report</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                <span class="n">loss_report</span><span class="p">,</span>
                <span class="n">train_step</span><span class="p">(</span>
                    <span class="n">generator</span><span class="p">,</span>
                    <span class="n">optimizer_gen</span><span class="p">,</span>
                    <span class="n">hazel_train</span><span class="p">,</span>
                    <span class="n">alder_train</span><span class="p">,</span>
                    <span class="kc">None</span><span class="p">,</span>
                    <span class="n">noise_dim</span><span class="p">,</span>
                    <span class="n">add_weather</span><span class="p">,</span>
                <span class="p">)</span><span class="o">.</span><span class="n">numpy</span><span class="p">(),</span>
            <span class="p">)</span>
        <span class="k">if</span> <span class="n">noise_dim</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">noise_train</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">normal</span><span class="p">([</span><span class="n">hazel_train</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">noise_dim</span><span class="p">])</span>
            <span class="n">generated_train</span> <span class="o">=</span> <span class="n">generator</span><span class="p">(</span>
                <span class="p">[</span><span class="n">noise_train</span><span class="p">,</span> <span class="n">hazel_train</span><span class="p">]</span> <span class="o">+</span> <span class="p">([</span><span class="n">weather_train</span><span class="p">]</span> <span class="k">if</span> <span class="n">add_weather</span> <span class="k">else</span> <span class="p">[])</span>
            <span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">generated_train</span> <span class="o">=</span> <span class="n">generator</span><span class="p">(</span>
                <span class="p">[</span><span class="n">hazel_train</span><span class="p">]</span> <span class="o">+</span> <span class="p">([</span><span class="n">weather_train</span><span class="p">]</span> <span class="k">if</span> <span class="n">add_weather</span> <span class="k">else</span> <span class="p">[])</span>
            <span class="p">)</span>

        <span class="n">index</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">randint</span><span class="p">(</span><span class="n">hazel_train</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>

        <span class="n">viz</span> <span class="o">=</span> <span class="p">(</span>
            <span class="n">hazel_train</span><span class="p">[</span><span class="n">index</span><span class="p">]</span> <span class="o">*</span> <span class="n">scale</span> <span class="o">+</span> <span class="n">center</span><span class="p">,</span>
            <span class="n">alder_train</span><span class="p">[</span><span class="n">index</span><span class="p">]</span> <span class="o">*</span> <span class="n">scale</span> <span class="o">+</span> <span class="n">center</span><span class="p">,</span>
            <span class="n">generated_train</span><span class="p">[</span><span class="n">index</span><span class="p">]</span><span class="o">.</span><span class="n">numpy</span><span class="p">()</span> <span class="o">*</span> <span class="n">scale</span> <span class="o">+</span> <span class="n">center</span><span class="p">,</span>
        <span class="p">)</span>

        <span class="n">write_png</span><span class="p">(</span>
            <span class="n">viz</span><span class="p">,</span>
            <span class="n">run_path</span>
            <span class="o">+</span> <span class="s2">&quot;/viz/&quot;</span>
            <span class="o">+</span> <span class="n">tune_trial</span>
            <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">epoch</span><span class="o">.</span><span class="n">numpy</span><span class="p">())</span>
            <span class="o">+</span> <span class="s2">&quot;-&quot;</span>
            <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">step</span><span class="o">.</span><span class="n">numpy</span><span class="p">())</span>
            <span class="o">+</span> <span class="s2">&quot;.png&quot;</span><span class="p">,</span>
            <span class="n">pretty</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
        <span class="p">)</span>

        <span class="n">step</span><span class="o">.</span><span class="n">assign_add</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>

    <span class="nb">print</span><span class="p">(</span>
        <span class="sa">f</span><span class="s2">&quot;Time taken for epoch </span><span class="si">{</span><span class="n">epoch</span><span class="o">.</span><span class="n">numpy</span><span class="p">()</span><span class="si">}</span><span class="s2"> is </span><span class="si">{</span><span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span> <span class="o">-</span> <span class="n">start</span><span class="si">}</span><span class="s2"> sec</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">,</span>
        <span class="n">flush</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="k">return</span> <span class="n">loss_report</span></div>


<div class="viewcode-block" id="validate_epoch"><a class="viewcode-back" href="../../modules.html#aldernet.utils.validate_epoch">[docs]</a><span class="k">def</span> <span class="nf">validate_epoch</span><span class="p">(</span>
    <span class="n">generator</span><span class="p">,</span>
    <span class="n">data_valid</span><span class="p">,</span>
    <span class="n">noise_dim</span><span class="p">,</span>
    <span class="n">add_weather</span><span class="p">,</span>
    <span class="n">center</span><span class="p">,</span>
    <span class="n">scale</span><span class="p">,</span>
    <span class="n">epoch</span><span class="p">,</span>
    <span class="n">step_valid</span><span class="p">,</span>
    <span class="n">run_path</span><span class="p">,</span>
    <span class="n">tune_trial</span><span class="p">,</span>
<span class="p">):</span>  <span class="c1"># pylint: disable=R0913,R0914</span>
    <span class="sd">&quot;&quot;&quot;Evaluate the generator for one epoch on validation data and return the loss.</span>

<span class="sd">    Args:</span>
<span class="sd">        generator (tf.keras.Model): The generator model. data_valid (Batcher): The</span>
<span class="sd">        validation data batcher. noise_dim (int): The dimensionality of the noise</span>
<span class="sd">        vector. add_weather (bool): If True, the weather data is included in training.</span>
<span class="sd">        center (float): The center value for the scaling. scale (float): The scale value</span>
<span class="sd">        for the scaling. epoch (tf.Variable): The current epoch. step_valid (int): The</span>
<span class="sd">        current validation step. run_path (str): The path to the directory where the</span>
<span class="sd">        output files will be stored. tune_trial (str): The name of the current Tune</span>
<span class="sd">        trial.</span>

<span class="sd">    Returns:</span>
<span class="sd">        Tuple[np.ndarray, int]: A tuple of loss values and the current validation step.</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">loss_valid</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">math</span><span class="o">.</span><span class="n">floor</span><span class="p">(</span><span class="n">data_valid</span><span class="o">.</span><span class="n">x</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">/</span> <span class="n">data_valid</span><span class="o">.</span><span class="n">batch_size</span><span class="p">)):</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">add_weather</span><span class="p">:</span>
            <span class="n">hazel_valid</span><span class="p">,</span> <span class="n">alder_valid</span> <span class="o">=</span> <span class="n">data_valid</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">hazel_valid</span><span class="p">,</span> <span class="n">weather_valid</span><span class="p">,</span> <span class="n">alder_valid</span> <span class="o">=</span> <span class="n">data_valid</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>

        <span class="k">if</span> <span class="n">noise_dim</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">noise_valid</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">normal</span><span class="p">([</span><span class="n">hazel_valid</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">noise_dim</span><span class="p">])</span>
            <span class="n">generated_valid</span> <span class="o">=</span> <span class="n">generator</span><span class="p">(</span>
                <span class="p">[</span><span class="n">noise_valid</span><span class="p">,</span> <span class="n">hazel_valid</span><span class="p">]</span> <span class="o">+</span> <span class="p">([</span><span class="n">weather_valid</span><span class="p">]</span> <span class="k">if</span> <span class="n">add_weather</span> <span class="k">else</span> <span class="p">[])</span>
            <span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">generated_valid</span> <span class="o">=</span> <span class="n">generator</span><span class="p">(</span>
                <span class="p">[</span><span class="n">hazel_valid</span><span class="p">]</span> <span class="o">+</span> <span class="p">([</span><span class="n">weather_valid</span><span class="p">]</span> <span class="k">if</span> <span class="n">add_weather</span> <span class="k">else</span> <span class="p">[])</span>
            <span class="p">)</span>

        <span class="n">index</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">randint</span><span class="p">(</span><span class="n">hazel_valid</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>

        <span class="n">viz</span> <span class="o">=</span> <span class="p">(</span>
            <span class="n">hazel_valid</span><span class="p">[</span><span class="n">index</span><span class="p">]</span> <span class="o">*</span> <span class="n">scale</span> <span class="o">+</span> <span class="n">center</span><span class="p">,</span>
            <span class="n">alder_valid</span><span class="p">[</span><span class="n">index</span><span class="p">]</span> <span class="o">*</span> <span class="n">scale</span> <span class="o">+</span> <span class="n">center</span><span class="p">,</span>
            <span class="n">generated_valid</span><span class="p">[</span><span class="n">index</span><span class="p">]</span><span class="o">.</span><span class="n">numpy</span><span class="p">()</span> <span class="o">*</span> <span class="n">scale</span> <span class="o">+</span> <span class="n">center</span><span class="p">,</span>
        <span class="p">)</span>

        <span class="n">write_png</span><span class="p">(</span>
            <span class="n">viz</span><span class="p">,</span>
            <span class="n">run_path</span>
            <span class="o">+</span> <span class="s2">&quot;/viz/valid/&quot;</span>
            <span class="o">+</span> <span class="n">tune_trial</span>
            <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">epoch</span><span class="o">.</span><span class="n">numpy</span><span class="p">())</span>
            <span class="o">+</span> <span class="s2">&quot;-&quot;</span>
            <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">step_valid</span><span class="p">)</span>
            <span class="o">+</span> <span class="s2">&quot;.png&quot;</span><span class="p">,</span>
            <span class="n">pretty</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="n">step_valid</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="n">loss_valid</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
            <span class="n">loss_valid</span><span class="p">,</span>
            <span class="n">tf</span><span class="o">.</span><span class="n">math</span><span class="o">.</span><span class="n">reduce_mean</span><span class="p">(</span><span class="n">tf</span><span class="o">.</span><span class="n">math</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">generated_valid</span> <span class="o">-</span> <span class="n">alder_valid</span><span class="p">))</span><span class="o">.</span><span class="n">numpy</span><span class="p">(),</span>
        <span class="p">)</span>

    <span class="k">return</span> <span class="n">loss_valid</span><span class="p">,</span> <span class="n">step_valid</span></div>


<div class="viewcode-block" id="train_model"><a class="viewcode-back" href="../../modules.html#aldernet.utils.train_model">[docs]</a><span class="k">def</span> <span class="nf">train_model</span><span class="p">(</span>  <span class="c1"># pylint: disable=R0912,R0913,R0914,R0915</span>
    <span class="n">config</span><span class="p">,</span> <span class="n">generator</span><span class="p">,</span> <span class="n">data_train</span><span class="p">,</span> <span class="n">data_valid</span><span class="p">,</span> <span class="n">run_path</span><span class="p">,</span> <span class="n">noise_dim</span><span class="p">,</span> <span class="n">add_weather</span><span class="p">,</span> <span class="n">shuffle</span>
<span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Train a model on the training data, with validation on the validation data.</span>

<span class="sd">    Args:</span>
<span class="sd">        config (Dict[str, Any]): Configuration dictionary. generator (tf.keras.Model):</span>
<span class="sd">        Generator model. data_train (xr.Dataset): Training data. data_valid</span>
<span class="sd">        (xr.Dataset): Validation data. run_path (str): Path to save the model</span>
<span class="sd">        checkpoints. noise_dim (int): Dimension of the noise input. add_weather (bool):</span>
<span class="sd">        Whether to add weather to the input data. shuffle (bool): Whether to shuffle the</span>
<span class="sd">        training data.</span>

<span class="sd">    Returns:</span>
<span class="sd">        None</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">data_train</span> <span class="o">=</span> <span class="n">create_batcher</span><span class="p">(</span><span class="n">data_train</span><span class="p">,</span> <span class="mi">32</span><span class="p">,</span> <span class="n">add_weather</span><span class="p">,</span> <span class="n">shuffle</span><span class="p">)</span>
    <span class="n">data_valid</span> <span class="o">=</span> <span class="n">create_batcher</span><span class="p">(</span><span class="n">data_valid</span><span class="p">,</span> <span class="mi">32</span><span class="p">,</span> <span class="n">add_weather</span><span class="p">,</span> <span class="n">shuffle</span><span class="p">)</span>
    <span class="n">mlflow</span><span class="o">.</span><span class="n">set_tracking_uri</span><span class="p">(</span><span class="n">run_path</span> <span class="o">+</span> <span class="s2">&quot;/mlruns&quot;</span><span class="p">)</span>
    <span class="n">mlflow</span><span class="o">.</span><span class="n">set_experiment</span><span class="p">(</span><span class="s2">&quot;Aldernet&quot;</span><span class="p">)</span>
    <span class="n">tune_trial</span> <span class="o">=</span> <span class="n">tune</span><span class="o">.</span><span class="n">get_trial_name</span><span class="p">()</span> <span class="o">+</span> <span class="s2">&quot;/&quot;</span>  <span class="c1"># type:ignore</span>
    <span class="n">setup_directories</span><span class="p">(</span><span class="n">run_path</span><span class="p">,</span> <span class="n">tune_trial</span><span class="p">)</span>
    <span class="n">epoch</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">Variable</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="s2">&quot;int64&quot;</span><span class="p">)</span>
    <span class="n">step</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">Variable</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="s2">&quot;int64&quot;</span><span class="p">)</span>
    <span class="n">step_valid</span> <span class="o">=</span> <span class="mi">1</span>
    <span class="n">checkpoint</span> <span class="o">=</span> <span class="n">Checkpoint</span><span class="o">.</span><span class="n">from_dict</span><span class="p">(</span><span class="nb">dict</span><span class="p">({</span><span class="s2">&quot;dummy&quot;</span><span class="p">:</span> <span class="mi">0</span><span class="p">}))</span>
    <span class="n">center</span><span class="p">,</span> <span class="n">scale</span> <span class="o">=</span> <span class="n">read_scaling_data</span><span class="p">()</span>
    <span class="n">optimizer_gen</span> <span class="o">=</span> <span class="n">create_optimizer</span><span class="p">(</span>
        <span class="n">config</span><span class="p">[</span><span class="s2">&quot;learning_rate&quot;</span><span class="p">],</span> <span class="n">config</span><span class="p">[</span><span class="s2">&quot;beta_1&quot;</span><span class="p">],</span> <span class="n">config</span><span class="p">[</span><span class="s2">&quot;beta_2&quot;</span><span class="p">]</span>
    <span class="p">)</span>

    <span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
        <span class="n">loss_report</span> <span class="o">=</span> <span class="n">train_epoch</span><span class="p">(</span>
            <span class="n">generator</span><span class="p">,</span>
            <span class="n">optimizer_gen</span><span class="p">,</span>
            <span class="n">data_train</span><span class="p">,</span>
            <span class="n">noise_dim</span><span class="p">,</span>
            <span class="n">add_weather</span><span class="p">,</span>
            <span class="n">center</span><span class="p">,</span>
            <span class="n">scale</span><span class="p">,</span>
            <span class="n">epoch</span><span class="p">,</span>
            <span class="n">step</span><span class="p">,</span>
            <span class="n">run_path</span><span class="p">,</span>
            <span class="n">tune_trial</span><span class="p">,</span>
        <span class="p">)</span>

        <span class="n">loss_valid</span><span class="p">,</span> <span class="n">step_valid</span> <span class="o">=</span> <span class="n">validate_epoch</span><span class="p">(</span>
            <span class="n">generator</span><span class="p">,</span>
            <span class="n">data_valid</span><span class="p">,</span>
            <span class="n">noise_dim</span><span class="p">,</span>
            <span class="n">add_weather</span><span class="p">,</span>
            <span class="n">center</span><span class="p">,</span>
            <span class="n">scale</span><span class="p">,</span>
            <span class="n">epoch</span><span class="p">,</span>
            <span class="n">step_valid</span><span class="p">,</span>
            <span class="n">run_path</span><span class="p">,</span>
            <span class="n">tune_trial</span><span class="p">,</span>
        <span class="p">)</span>

        <span class="n">checkpoint</span> <span class="o">=</span> <span class="n">Checkpoint</span><span class="o">.</span><span class="n">from_dict</span><span class="p">(</span>
            <span class="p">{</span>
                <span class="s2">&quot;epoch&quot;</span><span class="p">:</span> <span class="n">epoch</span><span class="p">,</span>
                <span class="s2">&quot;model&quot;</span><span class="p">:</span> <span class="n">generator</span><span class="p">,</span>
            <span class="p">}</span>
        <span class="p">)</span>

        <span class="n">session</span><span class="o">.</span><span class="n">report</span><span class="p">(</span>
            <span class="p">{</span>
                <span class="s2">&quot;iterations&quot;</span><span class="p">:</span> <span class="n">step</span><span class="p">,</span>
                <span class="s2">&quot;Loss_valid&quot;</span><span class="p">:</span> <span class="n">loss_valid</span><span class="o">.</span><span class="n">mean</span><span class="p">(),</span>
                <span class="s2">&quot;Loss&quot;</span><span class="p">:</span> <span class="n">loss_report</span><span class="o">.</span><span class="n">mean</span><span class="p">(),</span>
            <span class="p">},</span>
            <span class="n">checkpoint</span><span class="o">=</span><span class="n">checkpoint</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="n">epoch</span><span class="o">.</span><span class="n">assign_add</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">shuffle</span><span class="p">:</span>
            <span class="n">data_train</span><span class="o">.</span><span class="n">on_epoch_end</span><span class="p">()</span>
            <span class="n">data_valid</span><span class="o">.</span><span class="n">on_epoch_end</span><span class="p">()</span></div>


<div class="viewcode-block" id="build_unet"><a class="viewcode-back" href="../../modules.html#aldernet.utils.build_unet">[docs]</a><span class="k">def</span> <span class="nf">build_unet</span><span class="p">(</span><span class="n">conv</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>  <span class="c1"># pylint: disable=R0914</span>
    <span class="sd">&quot;&quot;&quot;Build a U-Net model.</span>

<span class="sd">    Args:</span>
<span class="sd">        conv (bool): Whether to use convolutional blocks.</span>

<span class="sd">    Returns:</span>
<span class="sd">        tf.keras.Model: U-Net model.</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">inputs</span> <span class="o">=</span> <span class="n">keras</span><span class="o">.</span><span class="n">Input</span><span class="p">(</span><span class="n">shape</span><span class="o">=</span><span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">))</span>

    <span class="n">s</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">keras</span><span class="o">.</span><span class="n">layers</span><span class="o">.</span><span class="n">Lambda</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span> <span class="o">/</span> <span class="mi">255</span><span class="p">)(</span><span class="n">inputs</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">conv</span><span class="p">:</span>
        <span class="n">conv_block_specs</span> <span class="o">=</span> <span class="p">[</span>
            <span class="p">(</span><span class="mi">16</span><span class="p">,</span> <span class="mf">0.1</span><span class="p">),</span>
            <span class="p">(</span><span class="mi">16</span><span class="p">,</span> <span class="mf">0.1</span><span class="p">),</span>
            <span class="p">(</span><span class="mi">32</span><span class="p">,</span> <span class="mf">0.1</span><span class="p">),</span>
            <span class="p">(</span><span class="mi">32</span><span class="p">,</span> <span class="mf">0.2</span><span class="p">),</span>
            <span class="p">(</span><span class="mi">64</span><span class="p">,</span> <span class="mf">0.2</span><span class="p">),</span>
            <span class="p">(</span><span class="mi">64</span><span class="p">,</span> <span class="mf">0.2</span><span class="p">),</span>
            <span class="p">(</span><span class="mi">128</span><span class="p">,</span> <span class="mf">0.2</span><span class="p">),</span>
            <span class="p">(</span><span class="mi">128</span><span class="p">,</span> <span class="mf">0.3</span><span class="p">),</span>
        <span class="p">]</span>
        <span class="n">conv_blocks</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">pool_layers</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="p">(</span><span class="n">filters</span><span class="p">,</span> <span class="n">dropout_rate</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">conv_block_specs</span><span class="p">):</span>
            <span class="n">block</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">keras</span><span class="o">.</span><span class="n">Sequential</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;conv_block_</span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="n">block</span><span class="o">.</span><span class="n">add</span><span class="p">(</span>
                <span class="n">tf</span><span class="o">.</span><span class="n">keras</span><span class="o">.</span><span class="n">layers</span><span class="o">.</span><span class="n">Conv2D</span><span class="p">(</span>
                    <span class="n">filters</span><span class="p">,</span>
                    <span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="mi">3</span><span class="p">),</span>
                    <span class="n">activation</span><span class="o">=</span><span class="n">tf</span><span class="o">.</span><span class="n">keras</span><span class="o">.</span><span class="n">activations</span><span class="o">.</span><span class="n">elu</span><span class="p">,</span>
                    <span class="n">kernel_initializer</span><span class="o">=</span><span class="s2">&quot;he_normal&quot;</span><span class="p">,</span>
                    <span class="n">padding</span><span class="o">=</span><span class="s2">&quot;same&quot;</span><span class="p">,</span>
                <span class="p">)</span>
            <span class="p">)</span>
            <span class="n">block</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">tf</span><span class="o">.</span><span class="n">keras</span><span class="o">.</span><span class="n">layers</span><span class="o">.</span><span class="n">Dropout</span><span class="p">(</span><span class="n">dropout_rate</span><span class="p">))</span>
            <span class="n">block</span><span class="o">.</span><span class="n">add</span><span class="p">(</span>
                <span class="n">tf</span><span class="o">.</span><span class="n">keras</span><span class="o">.</span><span class="n">layers</span><span class="o">.</span><span class="n">Conv2D</span><span class="p">(</span>
                    <span class="n">filters</span><span class="p">,</span>
                    <span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="mi">3</span><span class="p">),</span>
                    <span class="n">activation</span><span class="o">=</span><span class="n">tf</span><span class="o">.</span><span class="n">keras</span><span class="o">.</span><span class="n">activations</span><span class="o">.</span><span class="n">elu</span><span class="p">,</span>
                    <span class="n">kernel_initializer</span><span class="o">=</span><span class="s2">&quot;he_normal&quot;</span><span class="p">,</span>
                    <span class="n">padding</span><span class="o">=</span><span class="s2">&quot;same&quot;</span><span class="p">,</span>
                <span class="p">)</span>
            <span class="p">)</span>
            <span class="n">conv_blocks</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">block</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="nb">len</span><span class="p">(</span><span class="n">conv_block_specs</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">:</span>
                <span class="n">pool_layers</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">tf</span><span class="o">.</span><span class="n">keras</span><span class="o">.</span><span class="n">layers</span><span class="o">.</span><span class="n">MaxPooling2D</span><span class="p">((</span><span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">),</span> <span class="n">padding</span><span class="o">=</span><span class="s2">&quot;same&quot;</span><span class="p">))</span>

        <span class="n">c</span> <span class="o">=</span> <span class="n">s</span>
        <span class="k">for</span> <span class="n">conv_block</span><span class="p">,</span> <span class="n">pool_layer</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">conv_blocks</span><span class="p">,</span> <span class="n">pool_layers</span><span class="p">):</span>
            <span class="n">c</span> <span class="o">=</span> <span class="n">conv_block</span><span class="p">(</span><span class="n">c</span><span class="p">)</span>
            <span class="n">p</span> <span class="o">=</span> <span class="n">pool_layer</span><span class="p">(</span><span class="n">c</span><span class="p">)</span>

        <span class="n">c</span> <span class="o">=</span> <span class="n">conv_blocks</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">](</span><span class="n">p</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="p">(</span><span class="n">filters</span><span class="p">,</span> <span class="n">dropout_rate</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="nb">reversed</span><span class="p">(</span><span class="n">conv_block_specs</span><span class="p">)):</span>
            <span class="k">if</span> <span class="n">i</span> <span class="o">==</span> <span class="nb">len</span><span class="p">(</span><span class="n">conv_block_specs</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">:</span>
                <span class="k">break</span>
            <span class="n">u</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">keras</span><span class="o">.</span><span class="n">layers</span><span class="o">.</span><span class="n">Conv2DTranspose</span><span class="p">(</span>
                <span class="n">filters</span> <span class="o">//</span> <span class="mi">2</span><span class="p">,</span> <span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">),</span> <span class="n">strides</span><span class="o">=</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">),</span> <span class="n">padding</span><span class="o">=</span><span class="s2">&quot;same&quot;</span>
            <span class="p">)(</span><span class="n">c</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">u</span><span class="o">.</span><span class="n">shape</span> <span class="o">!=</span> <span class="n">conv_blocks</span><span class="p">[</span><span class="o">-</span><span class="n">i</span> <span class="o">-</span> <span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">output</span><span class="o">.</span><span class="n">shape</span><span class="p">:</span>
                <span class="n">u</span> <span class="o">=</span> <span class="n">layers</span><span class="o">.</span><span class="n">Cropping2D</span><span class="p">(</span><span class="n">cropping</span><span class="o">=</span><span class="p">((</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span> <span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">)),</span> <span class="n">data_format</span><span class="o">=</span><span class="kc">None</span><span class="p">)(</span><span class="n">u</span><span class="p">)</span>
            <span class="n">u</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">keras</span><span class="o">.</span><span class="n">layers</span><span class="o">.</span><span class="n">concatenate</span><span class="p">([</span><span class="n">u</span><span class="p">,</span> <span class="n">conv_blocks</span><span class="p">[</span><span class="o">-</span><span class="n">i</span> <span class="o">-</span> <span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">output</span><span class="p">])</span>
            <span class="n">c</span> <span class="o">=</span> <span class="n">conv_blocks</span><span class="p">[</span><span class="o">-</span><span class="n">i</span> <span class="o">-</span> <span class="mi">2</span><span class="p">](</span><span class="n">u</span><span class="p">)</span>
            <span class="n">c</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">keras</span><span class="o">.</span><span class="n">layers</span><span class="o">.</span><span class="n">Dropout</span><span class="p">(</span><span class="n">dropout_rate</span><span class="p">)(</span><span class="n">c</span><span class="p">)</span>
            <span class="n">c</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">keras</span><span class="o">.</span><span class="n">layers</span><span class="o">.</span><span class="n">Conv2D</span><span class="p">(</span>
                <span class="n">filters</span> <span class="o">//</span> <span class="mi">2</span><span class="p">,</span>
                <span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="mi">3</span><span class="p">),</span>
                <span class="n">activation</span><span class="o">=</span><span class="n">tf</span><span class="o">.</span><span class="n">keras</span><span class="o">.</span><span class="n">activations</span><span class="o">.</span><span class="n">elu</span><span class="p">,</span>
                <span class="n">kernel_initializer</span><span class="o">=</span><span class="s2">&quot;he_normal&quot;</span><span class="p">,</span>
                <span class="n">padding</span><span class="o">=</span><span class="s2">&quot;same&quot;</span><span class="p">,</span>
            <span class="p">)(</span><span class="n">c</span><span class="p">)</span>

        <span class="n">outputs</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">keras</span><span class="o">.</span><span class="n">layers</span><span class="o">.</span><span class="n">Conv2D</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span> <span class="n">activation</span><span class="o">=</span><span class="s2">&quot;sigmoid&quot;</span><span class="p">)(</span><span class="n">c</span><span class="p">)</span>

        <span class="n">model</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">keras</span><span class="o">.</span><span class="n">Model</span><span class="p">(</span><span class="n">inputs</span><span class="o">=</span><span class="n">inputs</span><span class="p">,</span> <span class="n">outputs</span><span class="o">=</span><span class="n">outputs</span><span class="p">)</span>

    <span class="k">else</span><span class="p">:</span>
        <span class="n">model</span> <span class="o">=</span> <span class="n">keras</span><span class="o">.</span><span class="n">models</span><span class="o">.</span><span class="n">Sequential</span><span class="p">()</span>
        <span class="n">model</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">layers</span><span class="o">.</span><span class="n">Dense</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">input_shape</span><span class="o">=</span><span class="p">([</span><span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">])))</span>
        <span class="n">model</span><span class="o">.</span><span class="n">add</span><span class="p">(</span>
            <span class="n">layers</span><span class="o">.</span><span class="n">Conv2D</span><span class="p">(</span>
                <span class="n">filters</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span>
                <span class="n">kernel_size</span><span class="o">=</span><span class="mi">4</span><span class="p">,</span>
                <span class="n">strides</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
                <span class="n">padding</span><span class="o">=</span><span class="s2">&quot;same&quot;</span><span class="p">,</span>
                <span class="n">use_bias</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
            <span class="p">)</span>
        <span class="p">)</span>
        <span class="n">model</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">layers</span><span class="o">.</span><span class="n">Dense</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">activation</span><span class="o">=</span><span class="s2">&quot;linear&quot;</span><span class="p">))</span>

    <span class="n">model</span><span class="o">.</span><span class="n">summary</span><span class="p">()</span>

    <span class="k">return</span> <span class="n">model</span></div>


<div class="viewcode-block" id="train_model_simple"><a class="viewcode-back" href="../../modules.html#aldernet.utils.train_model_simple">[docs]</a><span class="k">def</span> <span class="nf">train_model_simple</span><span class="p">(</span><span class="n">data_train</span><span class="p">,</span> <span class="n">data_valid</span><span class="p">,</span> <span class="n">epochs</span><span class="p">,</span> <span class="n">add_weather</span><span class="p">,</span> <span class="n">conv</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Train a simple U-Net model on `data_train` and validate on `data_valid`.</span>

<span class="sd">    Args:</span>
<span class="sd">        data_train (Batcher): Training data.</span>
<span class="sd">        data_valid (Batcher): Validation data.</span>
<span class="sd">        epochs (int): Number of epochs to train the model for. add_weather (bool):</span>
<span class="sd">        Whether or not to include weather data. conv (bool, optional): Whether to use</span>
<span class="sd">        convolutional layers (default is True).</span>

<span class="sd">    Returns:</span>
<span class="sd">        model (keras.Model): The trained U-Net model.</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">here</span><span class="p">())</span> <span class="o">+</span> <span class="s2">&quot;/data/scaling.txt&quot;</span><span class="p">,</span> <span class="s2">&quot;r&quot;</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="s2">&quot;utf-8&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
        <span class="n">lines</span> <span class="o">=</span> <span class="p">[</span><span class="n">line</span><span class="o">.</span><span class="n">rstrip</span><span class="p">()</span> <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">f</span><span class="p">]</span>
        <span class="n">center</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">lines</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;: &quot;</span><span class="p">)[</span><span class="mi">1</span><span class="p">])</span>
        <span class="n">scale</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">lines</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;: &quot;</span><span class="p">)[</span><span class="mi">1</span><span class="p">])</span>

    <span class="k">if</span> <span class="n">add_weather</span><span class="p">:</span>
        <span class="n">data_train</span><span class="o">.</span><span class="n">x</span> <span class="o">=</span> <span class="n">xr</span><span class="o">.</span><span class="n">concat</span><span class="p">([</span><span class="n">data_train</span><span class="o">.</span><span class="n">x</span><span class="p">,</span> <span class="n">data_train</span><span class="o">.</span><span class="n">weather</span><span class="p">],</span> <span class="n">dim</span><span class="o">=</span><span class="s2">&quot;var&quot;</span><span class="p">)</span>
        <span class="n">data_valid</span><span class="o">.</span><span class="n">x</span> <span class="o">=</span> <span class="n">xr</span><span class="o">.</span><span class="n">concat</span><span class="p">([</span><span class="n">data_valid</span><span class="o">.</span><span class="n">x</span><span class="p">,</span> <span class="n">data_valid</span><span class="o">.</span><span class="n">weather</span><span class="p">],</span> <span class="n">dim</span><span class="o">=</span><span class="s2">&quot;var&quot;</span><span class="p">)</span>

    <span class="n">model</span> <span class="o">=</span> <span class="n">build_unet</span><span class="p">(</span><span class="n">conv</span><span class="o">=</span><span class="n">conv</span><span class="p">)</span>

    <span class="n">model</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="n">optimizer</span><span class="o">=</span><span class="s2">&quot;adam&quot;</span><span class="p">,</span> <span class="n">loss</span><span class="o">=</span><span class="s2">&quot;binary_crossentropy&quot;</span><span class="p">,</span> <span class="n">metrics</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;accuracy&quot;</span><span class="p">])</span>

    <span class="n">model</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">data_train</span><span class="p">,</span> <span class="n">epochs</span><span class="o">=</span><span class="n">epochs</span><span class="p">)</span>

    <span class="n">predictions</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">data_valid</span><span class="p">)</span>

    <span class="k">for</span> <span class="n">timestep</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">predictions</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="mi">100</span><span class="p">):</span>
        <span class="n">inputs</span> <span class="o">=</span> <span class="p">(</span>
            <span class="n">data_valid</span><span class="o">.</span><span class="n">x</span><span class="p">[</span><span class="n">timestep</span><span class="p">]</span><span class="o">.</span><span class="n">values</span> <span class="o">*</span> <span class="n">scale</span> <span class="o">+</span> <span class="n">center</span><span class="p">,</span>
            <span class="n">data_valid</span><span class="o">.</span><span class="n">y</span><span class="p">[</span><span class="n">timestep</span><span class="p">]</span><span class="o">.</span><span class="n">values</span> <span class="o">*</span> <span class="n">scale</span> <span class="o">+</span> <span class="n">center</span><span class="p">,</span>
            <span class="n">predictions</span><span class="p">[</span><span class="n">timestep</span><span class="p">]</span> <span class="o">*</span> <span class="n">scale</span> <span class="o">+</span> <span class="n">center</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="n">path</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">here</span><span class="p">())</span> <span class="o">+</span> <span class="sa">f</span><span class="s2">&quot;/output/prediction</span><span class="si">{</span><span class="n">timestep</span><span class="si">}</span><span class="s2">.png&quot;</span>
        <span class="n">write_png</span><span class="p">(</span><span class="n">inputs</span><span class="p">,</span> <span class="n">path</span><span class="o">=</span><span class="n">path</span><span class="p">,</span> <span class="n">pretty</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">model</span></div>


<div class="viewcode-block" id="predict_season"><a class="viewcode-back" href="../../modules.html#aldernet.utils.predict_season">[docs]</a><span class="k">def</span> <span class="nf">predict_season</span><span class="p">(</span><span class="n">best_model</span><span class="p">,</span> <span class="n">data_valid</span><span class="p">,</span> <span class="n">noise_dim</span><span class="p">,</span> <span class="n">add_weather</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Use the trained `best_model` to predict the full pollen season for `data_valid`.</span>

<span class="sd">    Args:</span>
<span class="sd">        best_model (keras.Model): The trained U-Net model. data_valid (xarray.Dataset):</span>
<span class="sd">        The validation data. noise_dim (int): The dimensionality of the noise vector.</span>
<span class="sd">        add_weather (bool): Whether or not to include weather data.</span>

<span class="sd">    Returns:</span>
<span class="sd">        predictions (ndarray): The predicted pollen season.</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">data_valid</span> <span class="o">=</span> <span class="n">Batcher</span><span class="p">(</span>
        <span class="n">data_valid</span><span class="o">.</span><span class="n">sortby</span><span class="p">(</span><span class="s2">&quot;valid_time&quot;</span><span class="p">),</span>
        <span class="n">batch_size</span><span class="o">=</span><span class="mi">32</span><span class="p">,</span>
        <span class="n">add_weather</span><span class="o">=</span><span class="n">add_weather</span><span class="p">,</span>
        <span class="n">shuffle</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
    <span class="p">)</span>

    <span class="k">if</span> <span class="n">noise_dim</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">noise_season</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">normal</span><span class="p">([</span><span class="n">data_valid</span><span class="o">.</span><span class="n">x</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">noise_dim</span><span class="p">])</span>
        <span class="k">if</span> <span class="n">add_weather</span><span class="p">:</span>
            <span class="n">predictions</span> <span class="o">=</span> <span class="n">best_model</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span>
                <span class="p">[</span><span class="n">noise_season</span><span class="p">,</span> <span class="n">data_valid</span><span class="o">.</span><span class="n">x</span><span class="p">,</span> <span class="n">data_valid</span><span class="o">.</span><span class="n">weather</span><span class="p">]</span>
            <span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">predictions</span> <span class="o">=</span> <span class="n">best_model</span><span class="o">.</span><span class="n">predict</span><span class="p">([</span><span class="n">noise_season</span><span class="p">,</span> <span class="n">data_valid</span><span class="o">.</span><span class="n">x</span><span class="p">])</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">add_weather</span><span class="p">:</span>
            <span class="n">predictions</span> <span class="o">=</span> <span class="n">best_model</span><span class="o">.</span><span class="n">predict</span><span class="p">([</span><span class="n">data_valid</span><span class="o">.</span><span class="n">x</span><span class="p">,</span> <span class="n">data_valid</span><span class="o">.</span><span class="n">weather</span><span class="p">])</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">predictions</span> <span class="o">=</span> <span class="n">best_model</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">data_valid</span><span class="o">.</span><span class="n">x</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">predictions</span></div>
</pre></div>

          </div>
          
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
<h1 class="logo"><a href="../../index.html">Aldernet</a></h1>








<h3>Navigation</h3>
<p class="caption" role="heading"><span class="caption-text">Contents:</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../readme.html">Aldernet</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../installation.html">Installation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../usage.html">Usage</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../modules.html">Modules</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../contributing.html">Contributing</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../authors.html">Credits</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../history.html">History</a></li>
</ul>

<div class="relations">
<h3>Related Topics</h3>
<ul>
  <li><a href="../../index.html">Documentation overview</a><ul>
  <li><a href="../index.html">Module code</a><ul>
  </ul></li>
  </ul></li>
</ul>
</div>
<div id="searchbox" style="display: none" role="search">
  <h3 id="searchlabel">Quick search</h3>
    <div class="searchformwrapper">
    <form class="search" action="../../search.html" method="get">
      <input type="text" name="q" aria-labelledby="searchlabel" autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false"/>
      <input type="submit" value="Go" />
    </form>
    </div>
</div>
<script>document.getElementById('searchbox').style.display = "block"</script>








        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="footer">
      &copy;2023, MeteoSwiss.
      
      |
      Powered by <a href="http://sphinx-doc.org/">Sphinx 5.3.0</a>
      &amp; <a href="https://github.com/bitprophet/alabaster">Alabaster 0.7.12</a>
      
    </div>

    

    
  </body>
</html>